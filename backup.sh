#!/bin/bash

###############################################################################
# Automated Backup Script for LAIS Marketplace
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
###############################################################################

set -e

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f ".env" ]; then
    source .env
else
    print_error "–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
BACKUP_DIR="backups"
DB_BACKUP_DIR="$BACKUP_DIR/database"
CONFIG_BACKUP_DIR="$BACKUP_DIR/config"
RETENTION_DAYS=7

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
mkdir -p "$DB_BACKUP_DIR"
mkdir -p "$CONFIG_BACKUP_DIR"

# –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞
DATE=$(date +%Y%m%d_%H%M%S)

echo "========================================================================"
echo "  üíæ LAIS Marketplace - Automated Backup"
echo "  Date: $(date '+%Y-%m-%d %H:%M:%S')"
echo "========================================================================"
echo ""

###############################################################################
# 1. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
###############################################################################

print_status "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

DB_BACKUP_FILE="$DB_BACKUP_DIR/lais_db_${DATE}.sql"

if docker-compose exec -T postgres pg_dump -U "${POSTGRES_USER}" "${POSTGRES_DB}" > "$DB_BACKUP_FILE"; then
    print_success "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: $DB_BACKUP_FILE"
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
    DB_SIZE=$(du -h "$DB_BACKUP_FILE" | cut -f1)
    print_status "–†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞: $DB_SIZE"
    
    # –°–∂–∞—Ç–∏–µ –±—ç–∫–∞–ø–∞
    print_status "–°–∂–∞—Ç–∏–µ –±—ç–∫–∞–ø–∞..."
    gzip "$DB_BACKUP_FILE"
    
    COMPRESSED_SIZE=$(du -h "${DB_BACKUP_FILE}.gz" | cut -f1)
    print_success "–°–∂–∞—Ç—ã–π —Ä–∞–∑–º–µ—Ä: $COMPRESSED_SIZE"
else
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ë–î"
    exit 1
fi

###############################################################################
# 2. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
###############################################################################

print_status "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."

CONFIG_BACKUP_FILE="$CONFIG_BACKUP_DIR/config_${DATE}.tar.gz"

tar -czf "$CONFIG_BACKUP_FILE" \
    .env \
    docker-compose.yml \
    nginx/nginx.conf \
    --exclude='*.pyc' \
    --exclude='__pycache__' \
    2>/dev/null || true

if [ -f "$CONFIG_BACKUP_FILE" ]; then
    CONFIG_SIZE=$(du -h "$CONFIG_BACKUP_FILE" | cut -f1)
    print_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: $CONFIG_BACKUP_FILE ($CONFIG_SIZE)"
else
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
fi

###############################################################################
# 3. –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤
###############################################################################

print_status "–£–¥–∞–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤ —Å—Ç–∞—Ä—à–µ $RETENTION_DAYS –¥–Ω–µ–π..."

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ –ë–î
DELETED_DB=$(find "$DB_BACKUP_DIR" -name "*.sql.gz" -type f -mtime +$RETENTION_DAYS -delete -print | wc -l)
print_status "–£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ –ë–î: $DELETED_DB"

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
DELETED_CONFIG=$(find "$CONFIG_BACKUP_DIR" -name "*.tar.gz" -type f -mtime +$RETENTION_DAYS -delete -print | wc -l)
print_status "–£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: $DELETED_CONFIG"

###############################################################################
# 4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
###############################################################################

echo ""
echo "========================================================================"
echo "  üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π"
echo "========================================================================"
echo ""

print_status "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ($DB_BACKUP_DIR):"
ls -lh "$DB_BACKUP_DIR" | tail -n +2 | tail -5

echo ""
print_status "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ($CONFIG_BACKUP_DIR):"
ls -lh "$CONFIG_BACKUP_DIR" | tail -n +2 | tail -5

echo ""
print_status "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞:"
du -sh "$BACKUP_DIR"

echo ""
print_success "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"

###############################################################################
# 5. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
###############################################################################

# –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
# REMOTE_SERVER="user@backup-server.com"
# REMOTE_PATH="/backups/lais"

# print_status "–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä..."
# scp "${DB_BACKUP_FILE}.gz" "$REMOTE_SERVER:$REMOTE_PATH/"
# if [ $? -eq 0 ]; then
#     print_success "–ë—ç–∫–∞–ø –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä"
# else
#     print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä"
# fi
