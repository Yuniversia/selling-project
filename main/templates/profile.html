<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    {% set page_title = t.my_profile + " - LAIS Marketplace" %}
    {% set page_description = t.manage_ads %}
    {% include 'seo_meta.html' %}
    <title>{{ page_title }}</title>
    <link rel="stylesheet" href="/templates/static/styles2.css?v=16">
    <script src="/templates/static/cache-manager.js?v=16"></script>
    <script src="/templates/static/notifications.js?v=16" defer></script>
    <script src="/templates/static/notification-prompt.js?v=16" defer></script>
    <script>
        // Global translations object for JavaScript
        window.i18n = {
            loading: "{{ t.loading }}",
            chatWithSeller: "{{ t.js_chat_with_seller }}",
            writeMessage: "{{ t.writeMessage }}",
            insufficientData: "{{ t.js_chat_insufficient_data }}",
            startDialog: "{{ t.js_chat_start_dialog }}",
            createFailed: "{{ t.js_chat_create_failed }}",
            loadMessagesFailed: "{{ t.js_chat_load_messages_failed }}",
            connectionFailed: "{{ t.js_chat_connection_failed }}",
            seller: "{{ t.js_chat_seller }}",
            online: "{{ t.js_chat_online }}",
            offline: "{{ t.js_chat_offline }}",
            // Seller chats
            initialization: "{{ t.initialization }}",
            user_data: "{{ t.user_data }}",
            my_chats: "{{ t.my_chats }}",
            select_chat: "{{ t.select_chat }}",
            buyer: "{{ t.buyer }}",
            product: "{{ t.product }}",
            hide_chat: "{{ t.hide_chat }}",
            delete_chat: "{{ t.delete_chat }}",
            back: "{{ t.back }}",
            no_messages: "{{ t.no_messages }}",
            anonymous_buyer: "{{ t.anonymous_buyer }}",
            no_messages_yet: "{{ t.no_messages_yet }}",
            listing: "{{ t.listing }}",
            messages_load_error: "{{ t.messages_load_error }}",
            ws_not_connected: "{{ t.ws_not_connected }}",
            send_error: "{{ t.send_error }}",
            yes: "{{ t.yes }}",
            cancel: "{{ t.cancel }}",
            hide_chat_feature: "{{ t.hide_chat_feature }}",
            delete_chat_confirm: "{{ t.delete_chat_confirm }}",
            success: "{{ t.success }}",
            chat_deleted: "{{ t.chat_deleted }}",
            delete_error: "{{ t.delete_error }}",
            yesterday: "{{ t.yesterday }}",
            chatsLoading: "{{ t.chatsLoading }}",
            messagesLoading: "{{ t.messagesLoading }}",
            chatsLoadFailed: "{{ t.chatsLoadFailed }}",
            chatsConnectionError: "{{ t.chatsConnectionError }}",
            chatsOpenFailed: "{{ t.chatsOpenFailed }}",
            messagesLoadFailed: "{{ t.messagesLoadFailed }}",
            connectionLost: "{{ t.connectionLost }}",
            sendFailed: "{{ t.sendFailed }}",
            deleteFailed: "{{ t.deleteFailed }}",
            error: "{{ t.error }}",
            // Notifications
            js_notif_not_supported: "{{ t.js_notif_not_supported }}",
            js_notif_sw_registered: "{{ t.js_notif_sw_registered }}",
            js_notif_sw_active: "{{ t.js_notif_sw_active }}",
            js_notif_sw_error: "{{ t.js_notif_sw_error }}",
            js_notif_permission_granted: "{{ t.js_notif_permission_granted }}",
            js_notif_permission_denied: "{{ t.js_notif_permission_denied }}",
            js_notif_permission_error: "{{ t.js_notif_permission_error }}",
            js_notif_no_permission: "{{ t.js_notif_no_permission }}",
            js_notif_shown: "{{ t.js_notif_shown }}",
            js_notif_show_error: "{{ t.js_notif_show_error }}",
            js_notif_new_message: "{{ t.js_notif_new_message }}",
            js_notif_default_body: "{{ t.js_notif_default_body }}",
            js_notif_window_active: "{{ t.js_notif_window_active }}",
            js_notif_new_message_from: "{{ t.js_notif_new_message_from }}",
            js_notif_open_chat: "{{ t.js_notif_open_chat }}",
            js_notif_close: "{{ t.js_notif_close }}",
            js_notif_permission_already: "{{ t.js_notif_permission_already }}",
            js_notif_prompt_title: "{{ t.js_notif_prompt_title }}",
            js_notif_prompt_description: "{{ t.js_notif_prompt_description }}",
            js_notif_enabled: "{{ t.js_notif_enabled }}",
            js_sw_installed: "{{ t.js_sw_installed }}",
            js_sw_activated: "{{ t.js_sw_activated }}",
            js_sw_push_received: "{{ t.js_sw_push_received }}",
            js_sw_notification_click: "{{ t.js_sw_notification_click }}",
            js_sw_notification_closed: "{{ t.js_sw_notification_closed }}",
            js_sw_open: "{{ t.js_sw_open }}",
            // Profile auth
            js_auth_required: "{{ t.js_auth_required }}",
            js_session_expired: "{{ t.js_session_expired }}",
            js_data_saved_console: "{{ t.js_data_saved_console }}"
        };
    </script>
    <script src="/templates/static/chat.js?v=16" defer></script>
    <script>
        // API Configuration - –µ–¥–∏–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç /api/v1/<service>
        const API_V1 = "/api/v1";
        const AUTH_API = `${API_V1}/auth`;
        const POSTS_API = `${API_V1}/posts`;
        const CHAT_API = `${API_V1}/chat`;
        const IMEI_API = `${API_V1}/imei`;
        console.log('üîß API BASE:', API_V1);
    </script>
    <script src="/templates/static/seller-chats.js?v=16" defer></script>
    <style>
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 40px;
            margin-top: 20px;
        }

        /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–ö–∞—Ä—Ç–æ—á–∫–∞) */
        .profile-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            position: sticky;
            top: 100px; /* –ß—Ç–æ–±—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∞—Å—å –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
            height: fit-content;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background-color: #f5f5f7;
            background-size: cover;
            background-position: center;
            box-shadow: var(--shadow-sm);
        }

        .profile-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--color-text);
        }

        .profile-tag {
            font-size: 14px;
            color: var(--color-text-light);
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--color-border);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-text);
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-light);
        }

        /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–§–æ—Ä–º–∞) */
        .settings-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 24px;
            padding: 40px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* –†–µ–π—Ç–∏–Ω–≥ */
        .rating-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #fff9c4; /* –°–≤–µ—Ç–ª–æ-–∂–µ–ª—Ç—ã–π */
            color: #f57f17;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 16px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤ */
        @media (max-width: 850px) {
            .profile-layout {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            .profile-card {
                position: static;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            .settings-card {
                padding: 24px;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –∂–∞–ª–æ–± */
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--color-border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #f5f5f7;
        }

        .filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .report-card {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .report-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .report-card.pending {
            border-left: 4px solid #ff3b30;
        }

        .report-card.reviewed {
            border-left: 4px solid #007aff;
        }

        .report-card.resolved {
            border-left: 4px solid #34c759;
        }

        .report-card.rejected {
            border-left: 4px solid #999;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.pending {
            background: #ffebee;
            color: #ff3b30;
        }

        .status-badge.reviewed {
            background: #e3f2fd;
            color: #007aff;
        }

        .status-badge.resolved {
            background: #e8f5e9;
            color: #34c759;
        }

        .status-badge.rejected {
            background: #f5f5f5;
            color: #999;
        }
    </style>
</head>
<body id="profilePage">

    <header class="header-fixed">
        <div class="nav-container">
            <a href="/" class="logo">lais</a>
            <div class="header-controls">
                <a href="/" class="btn btn-text">{{ t.home_page }}</a>
                <button id="logoutBtn" class="btn btn-outline" style="color: var(--color-error); border-color: var(--color-error);">{{ t.sign_out }}</button>
            </div>
        </div>
    </header>

    <main class="main-container">
        
        <h1 style="font-size: 32px; font-weight: 800; margin-bottom: 10px;">{{ t.my_profile_title }}</h1>
        
        <div class="profile-layout">
            
            <aside class="profile-card">
                <div class="profile-avatar-large" id="avatarDisplay"></div>

                <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ -->
                <div>
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                    <button class="btn btn-text" style="font-size: 13px; padding: 6px 12px; margin-bottom: 12px;" onclick="document.getElementById('avatarInput').click()">
                        {{ t.change_photo }}
                    </button>
                </div>
                
                
                <div class="rating-badge">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                    <span id="ratingDisplay">5.0</span>
                </div>

                

                <h2 class="profile-name" id="usernameDisplay">{{ t.reports_loading }}</h2>
                <div class="profile-tag">{{ t.on_lais_since }} <span id="joinedDateDisplay">...</span></div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="adsCountDisplay">0</span>
                        <span class="stat-label">{{ t.ads_count }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="sellsCountDisplay">0</span>
                        <span class="stat-label">{{ t.sales_count }}</span>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –∏ –ø—Ä–æ–¥–∞–∂ -->
                <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                    <a href="/my-orders" class="btn btn-outline" style="width: 100%; text-decoration: none; text-align: center; padding: 12px;">
                        {{ t.my_orders }}
                    </a>
                    <a href="/my-sales" class="btn btn-outline" style="width: 100%; text-decoration: none; text-align: center; padding: 12px;">
                        {{ t.my_sales }}
                    </a>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤/–ø–æ–¥–¥–µ—Ä–∂–∫–∏ -->
                {% if user and (user.user_type == 'admin' or user.user_type == 'support') %}
                <div id="adminPanel" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--color-border);">
                    <button id="reportsBtn" class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: 600;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        {{ t.reports_title }}
                        <span id="pendingReportsCount" style="background: #fff; color: #667eea; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; margin-left: 8px;">0</span>
                    </button>
                </div>
                {% endif %}
            </aside>

            <section class="settings-card">
                <h3 class="section-title">{{ t.personal_data }}</h3>
                
                <form id="profileForm" onsubmit="event.preventDefault();">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">{{ t.first_name }}</label>
                            <input type="text" class="form-input" id="firstNameInput" placeholder="{{ t.your_name }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">{{ t.last_name }}</label>
                            <input type="text" class="form-input" id="lastNameInput" placeholder="{{ t.your_surname }}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">{{ t.username }}</label>
                        <input type="text" class="form-input" id="usernameInput" readonly style="background: #f5f5f7; color: #888; cursor: not-allowed;">
                        <span style="font-size: 12px; color: var(--color-text-light); margin-top: 4px; display: block;">{{ t.username_readonly }}</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">{{ t.email }}</label>
                        <input type="email" class="form-input" id="emailInput" placeholder="example@mail.com">
                        <span id="emailError" style="font-size: 12px; color: #f44336; margin-top: 4px; display: none;"></span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">{{ t.phone }}</label>
                        <input type="tel" class="form-input" id="phoneInput" placeholder="+371 12345678">
                        <span id="phoneError" style="font-size: 12px; color: #f44336; margin-top: 4px; display: none;"></span>
                    </div>

                    <div class="form-group" style="margin-top: 30px;">
                        <button type="submit" class="btn btn-primary" style="padding: 14px 32px;">{{ t.save_changes }}</button>
                        <div id="successMessage" style="display: none; margin-top: 12px; padding: 12px; background: #d4edda; color: #155724; border-radius: 8px; font-size: 14px;">
                            {{ t.profile_updated }}
                        </div>
                    </div>

                </form>
            </section>

        </div>

    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∞–ª–æ–±–∞–º–∏ (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
    <div id="reportsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">{{ t.admin_reports_management }}</h2>
                <button onclick="closeReportsModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999;">√ó</button>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                <button class="filter-btn active" data-filter="all" onclick="filterReports('all')">{{ t.filter_all }}</button>
                <button class="filter-btn" data-filter="pending" onclick="filterReports('pending')">{{ t.filter_pending }}</button>
                <button class="filter-btn" data-filter="reviewed" onclick="filterReports('reviewed')">{{ t.filter_reviewed }}</button>
                <button class="filter-btn" data-filter="resolved" onclick="filterReports('resolved')">–†–µ—à–µ–Ω–Ω—ã–µ</button>
                <button class="filter-btn" data-filter="rejected" onclick="filterReports('rejected')">–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</button>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∂–∞–ª–æ–± -->
            <div id="reportsList" style="flex: 1; overflow-y: auto; border: 1px solid var(--color-border); border-radius: 12px; padding: 20px;">
                <div style="text-align: center; color: var(--color-text-light);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∂–∞–ª–æ–±–µ -->
    <div id="reportDetailModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">–ñ–∞–ª–æ–±–∞ #<span id="reportDetailId">0</span></h2>
                <button onclick="closeReportDetailModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999;">√ó</button>
            </div>

            <div id="reportDetailContent">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--color-border);">
                <button onclick="goToPost()" class="btn btn-outline" style="flex: 1;">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—é</button>
                <button onclick="deactivatePostFromReport()" class="btn btn-outline" style="flex: 1; color: #ff3b30; border-color: #ff3b30;">–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç</button>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 12px;">
                <button onclick="updateReportStatus('reviewed')" class="btn btn-outline" style="flex: 1;">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</button>
                <button onclick="updateReportStatus('resolved')" class="btn btn-primary" style="flex: 1; background: #34c759;">–†–µ—à–µ–Ω–æ</button>
                <button onclick="updateReportStatus('rejected')" class="btn btn-outline" style="flex: 1; color: #999;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // Translations for JavaScript
        window.t = {
            js_auth_required: "{{ t.js_auth_required }}",
            js_session_expired: "{{ t.js_session_expired }}",
            js_file_too_large: "{{ t.js_file_too_large }}",
            js_only_images: "{{ t.js_only_images }}",
            js_photo_upload_failed: "{{ t.js_photo_upload_failed }}",
            js_confirm_deactivate: "{{ t.js_confirm_deactivate }}",
            js_post_deactivated: "{{ t.js_post_deactivated }}",
            js_report_updated: "{{ t.js_report_updated }}",
            js_connection_error: "{{ t.js_connection_error }}",
            reports_loading: "{{ t.reports_loading }}",
            loading_error: "{{ t.loading_error }}",
            no_reports_found: "{{ t.no_reports_found }}",
            filter_all: "{{ t.filter_all }}",
            filter_pending: "{{ t.filter_pending }}",
            filter_reviewed: "{{ t.filter_reviewed }}",
            filter_resolved: "{{ t.filter_resolved }}",
            filter_rejected: "{{ t.filter_rejected }}",
            reports_management: "{{ t.reports_management }}",
            go_to_post: "{{ t.go_to_post }}",
            deactivate_post: "{{ t.deactivate_post }}",
            status_reviewed: "{{ t.status_reviewed }}",
            status_resolved: "{{ t.status_resolved }}",
            status_reject: "{{ t.status_reject }}",
            report_on_post: "{{ t.report_on_post }}",
            model_unknown: "{{ t.model_unknown }}",
            report_reason: "{{ t.report_reason }}",
            additional_info: "{{ t.additional_info }}",
            report_sender: "{{ t.report_sender }}",
            report_status: "{{ t.report_status }}",
            report_created: "{{ t.report_created }}",
            report_reviewed: "{{ t.report_reviewed }}",
            post_active: "{{ t.post_active }}",
            post_inactive: "{{ t.post_inactive }}",
            anonymous_reporter: "{{ t.anonymous_reporter }}",
            user_prefix: "{{ t.user_prefix }}",
            moderator_prefix: "{{ t.moderator_prefix }}"
        };
        
        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
        async function initProfile() {
            try {
                // 1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const response = await fetch(`${AUTH_API}/me`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include' // –í–∞–∂–Ω–æ –¥–ª—è HttpOnly cookies
                });

                if (!response.ok) {
                    // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (401), —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    window.location.href = '/';
                    return;
                }

                const user = await response.json();
                renderUserData(user);

            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", err);
                // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        function renderUserData(user) {
            // -- –ë–ª–æ–∫ –ö–∞—Ä—Ç–æ—á–∫–∏ --
            document.getElementById('usernameDisplay').textContent = user.username || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≤–∞—Ç–∞—Ä–∞
            const avatarUrl = user.avatar_url || `https://ui-avatars.com/api/?name=${user.username}&background=0D8ABC&color=fff&size=256`;
            document.getElementById('avatarDisplay').style.backgroundImage = `url('${avatarUrl}')`;

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            document.getElementById('joinedDateDisplay').textContent = user.joined_date || "...";
            document.getElementById('ratingDisplay').textContent = parseFloat(user.rating || 5.0).toFixed(1);
            document.getElementById('adsCountDisplay').textContent = user.posts_count || 0;
            document.getElementById('sellsCountDisplay').textContent = user.sells_count || 0;

            // -- –ë–ª–æ–∫ –§–æ—Ä–º—ã --
            document.getElementById('usernameInput').value = user.username;
            document.getElementById('emailInput').value = user.email || "";
            document.getElementById("firstNameInput").value = user.name || "";
            document.getElementById("lastNameInput").value = user.surname || "";
            document.getElementById("phoneInput").value = user.phone || "";
        }

        // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ –í—ã—Ö–æ–¥–∞
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch(`${AUTH_API}/logout`, { method: 'POST', credentials: 'include' });
                
                // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, —Å–æ—Ö—Ä–∞–Ω—è—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                clearUserData();
                
                window.location.href = '/';
            } catch (e) {
                console.error(e);
                
                // –û—á–∏—â–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                clearUserData();
                
                window.location.href = '/';
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        function clearUserData() {
            // –û—á–∏—â–∞–µ–º –∫—ç—à API (–∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ clearUserData)
            if (window.cacheManager && typeof cacheManager.clearUserData === 'function') {
                cacheManager.clearUserData();
            }
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage, —Å–æ—Ö—Ä–∞–Ω—è—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const keysToKeep = [
                'lais_cookie_consent',      // –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ cookies
                'lais_push_permission',     // –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                'filters_collapsed',        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                'theme_preference',         // –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
                'api_cache'                 // –ö—ç—à API (–æ—á–∏—â–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ cacheManager.clearUserData)
            ];
            const itemsToKeep = {};
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω—É–∂–Ω—ã–µ –∫–ª—é—á–∏
            keysToKeep.forEach(key => {
                const value = localStorage.getItem(key);
                if (value !== null) {
                    itemsToKeep[key] = value;
                }
            });
            
            // –û—á–∏—â–∞–µ–º –≤–µ—Å—å localStorage –∏ sessionStorage
            localStorage.clear();
            sessionStorage.clear();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            Object.keys(itemsToKeep).forEach(key => {
                localStorage.setItem(key, itemsToKeep[key]);
            });
            
            console.log('[Logout] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
        document.getElementById('avatarInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (–º–∞–∫—Å 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 5MB');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞
            if (!file.type.startsWith('image/')) {
                alert('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                return;
            }

            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const avatarDisplay = document.getElementById('avatarDisplay');
                avatarDisplay.style.opacity = '0.5';

                // –ü–æ–ª—É—á–∞–µ–º URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                const linkResponse = await fetch(`${POSTS_API}/r2_link`);
                const linkData = await linkResponse.json();

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ Cloudflare
                const formData = new FormData();
                formData.append('file', file);

                const uploadResponse = await fetch(linkData.upload_url, {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ');
                }

                const uploadResult = await uploadResponse.json();
                const imageId = uploadResult.result.id;
                const newAvatarUrl = `${linkData.image_delivery_base}/${imageId}/public`;

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å –Ω–æ–≤—ã–º –∞–≤–∞—Ç–∞—Ä–æ–º
                const updateResponse = await fetch(`${AUTH_API}/me`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ avatar_url: newAvatarUrl })
                });

                if (updateResponse.ok) {
                    avatarDisplay.style.backgroundImage = `url('${newAvatarUrl}')`;
                    avatarDisplay.style.opacity = '1';
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ');
                document.getElementById('avatarDisplay').style.opacity = '1';
            }
        });

        // –õ–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.querySelector('#profileForm button[type="submit"]');
            const originalText = btn.innerText;
            const successMessage = document.getElementById('successMessage');
            const emailError = document.getElementById('emailError');
            const phoneError = document.getElementById('phoneError');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
            emailError.style.display = 'none';
            phoneError.style.display = 'none';
            successMessage.style.display = 'none';
            
            btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
            btn.disabled = true;

            try {
                const updateData = {
                    name: document.getElementById('firstNameInput').value,
                    surname: document.getElementById('lastNameInput').value,
                    email: document.getElementById('emailInput').value,
                    phone: document.getElementById('phoneInput').value
                };

                const response = await fetch(`${AUTH_API}/me`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();

                if (response.ok) {
                    btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
                    btn.style.backgroundColor = "#34c759";
                    successMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.style.backgroundColor = "";
                        btn.disabled = false;
                        successMessage.style.display = 'none';
                    }, 3000);
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                    if (result.errors) {
                        if (result.errors.email) {
                            emailError.textContent = result.errors.email;
                            emailError.style.display = 'block';
                        }
                        if (result.errors.phone) {
                            phoneError.textContent = result.errors.phone;
                            phoneError.style.display = 'block';
                        }
                    }
                    
                    btn.innerText = originalText;
                    btn.disabled = false;
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        // –ó–∞–ø—É—Å–∫
        initProfile();


        // === –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ –ñ–ê–õ–û–ë ===

        let allReports = [];
        let currentFilter = 'all';
        let currentReportId = null;
        let currentPostId = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∂–∞–ª–æ–±
        function getUserTypeFromToken() {
            const token = document.cookie
                .split('; ')
                .find(row => row.startsWith('access_token='))
                ?.split('=')[1];
            
            if (!token) return null;
            
            try {
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º JWT (base64 decode payload)
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.user_type || null;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
                return null;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–∂–∏–¥–∞—é—â–∏—Ö –∂–∞–ª–æ–±
        async function loadPendingReportsCount() {
            try {
                const response = await fetch(`${POSTS_API}/admin/reports?status_filter=pending`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const reports = await response.json();
                    document.getElementById('pendingReportsCount').textContent = reports.length;
                }
            } catch (error) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –∂–∞–ª–æ–±');
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∂–∞–ª–æ–±
        document.getElementById('reportsBtn')?.addEventListener('click', async () => {
            document.getElementById('reportsModal').style.display = 'flex';
            await loadReports();
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeReportsModal() {
            document.getElementById('reportsModal').style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∂–∞–ª–æ–±
        async function loadReports() {
            try {
                const response = await fetch(`${POSTS_API}/admin/reports?limit=200`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    allReports = await response.json();
                    displayReports();
                } else {
                    document.getElementById('reportsList').innerHTML = 
                        '<div style="text-align: center; color: var(--color-error);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–∞–ª–æ–±</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–∞–ª–æ–±:', error);
                document.getElementById('reportsList').innerHTML = 
                    '<div style="text-align: center; color: var(--color-error);">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>';
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∂–∞–ª–æ–±
        function filterReports(filter) {
            currentFilter = filter;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            displayReports();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∂–∞–ª–æ–±
        function displayReports() {
            const container = document.getElementById('reportsList');
            
            let filtered = allReports;
            if (currentFilter !== 'all') {
                filtered = allReports.filter(r => r.status === currentFilter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--color-text-light); padding: 40px;">–ñ–∞–ª–æ–± –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }
            
            container.innerHTML = filtered.map(report => {
                const statusText = {
                    'pending': '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
                    'reviewed': '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ',
                    'resolved': '–†–µ—à–µ–Ω–æ',
                    'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
                }[report.status];
                
                const date = new Date(report.created_at).toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="report-card ${report.status}" onclick="openReportDetail(${report.id})">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">
                                    –ñ–∞–ª–æ–±–∞ #${report.id} –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ #${report.post_id}
                                </div>
                                <div style="font-size: 13px; color: var(--color-text-light);">
                                    ${report.post_model || '–ú–æ–¥–µ–ª—å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}
                                </div>
                            </div>
                            <span class="status-badge ${report.status}">${statusText}</span>
                        </div>
                        <div style="font-size: 14px; color: var(--color-text-light); margin-bottom: 8px;">
                            <strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${report.reason}
                        </div>
                        ${report.details ? `
                            <div style="font-size: 13px; color: var(--color-text-light); margin-bottom: 8px; padding: 8px; background: #f5f5f7; border-radius: 6px;">
                                ${report.details.substring(0, 100)}${report.details.length > 100 ? '...' : ''}
                            </div>
                        ` : ''}
                        <div style="font-size: 12px; color: var(--color-text-light);">
                            ${date} ‚Ä¢ ${report.reporter_id ? `User #${report.reporter_id}` : report.reporter_ip}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∂–∞–ª–æ–±–µ
        async function openReportDetail(reportId) {
            const report = allReports.find(r => r.id === reportId);
            if (!report) return;
            
            currentReportId = reportId;
            currentPostId = report.post_id;
            
            document.getElementById('reportDetailId').textContent = reportId;
            
            const statusText = {
                'pending': '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
                'reviewed': '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ',
                'resolved': '–†–µ—à–µ–Ω–æ',
                'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
            }[report.status];
            
            const date = new Date(report.created_at).toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            document.getElementById('reportDetailContent').innerHTML = `
                <div style="display: grid; gap: 16px;">
                    <div>
                        <div style="font-size: 13px; color: var(--color-text-light); margin-bottom: 4px;">–û–±—ä—è–≤–ª–µ–Ω–∏–µ</div>
                        <div style="font-weight: 600;">
                            #${report.post_id} - ${report.post_model || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                            <span style="margin-left: 12px; padding: 4px 8px; background: ${report.post_active ? '#e8f5e9' : '#ffebee'}; color: ${report.post_active ? '#34c759' : '#ff3b30'}; border-radius: 6px; font-size: 12px;">
                                ${report.post_active ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ'}
                            </span>
                        </div>
                    </div>
                    
                    <div>
                        <div style="font-size: 13px; color: var(--color-text-light); margin-bottom: 4px;">–ü—Ä–∏—á–∏–Ω–∞</div>
                        <div style="font-weight: 600;">${report.reason}</div>
                    </div>
                    
                    ${report.details ? `
                        <div>
                            <div style="font-size: 13px; color: var(--color-text-light); margin-bottom: 4px;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                            <div style="padding: 12px; background: #f5f5f7; border-radius: 8px; white-space: pre-wrap;">${report.details}</div>
                        </div>
                    ` : ''}
                    
                    <div>
                        <div style="font-size: 13px; color: var(--color-text-light); margin-bottom: 4px;">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</div>
                        <div>${report.reporter_id ? `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${report.reporter_id}` : `–ê–Ω–æ–Ω–∏–º–Ω—ã–π (${report.reporter_ip})`}</div>
                    </div>
                    
                    <div>
                        <div style="font-size: 13px; color: var(--color-text-light); margin-bottom: 4px;">–°—Ç–∞—Ç—É—Å</div>
                        <span class="status-badge ${report.status}">${statusText}</span>
                    </div>
                    
                    <div>
                        <div style="font-size: 13px; color: var(--color-text-light); margin-bottom: 4px;">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</div>
                        <div>${date}</div>
                    </div>
                    
                    ${report.reviewed_at ? `
                        <div>
                            <div style="font-size: 13px; color: var(--color-text-light); margin-bottom: 4px;">–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ</div>
                            <div>${new Date(report.reviewed_at).toLocaleString('ru-RU')} ${report.reviewed_by ? `(–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä #${report.reviewed_by})` : ''}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('reportDetailModal').style.display = 'flex';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeReportDetailModal() {
            document.getElementById('reportDetailModal').style.display = 'none';
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—é
        function goToPost() {
            if (currentPostId) {
                window.open(`/product?id=${currentPostId}`, '_blank');
            }
        }

        // –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ—Å—Ç–∞ –∏–∑ –∂–∞–ª–æ–±—ã
        async function deactivatePostFromReport() {
            if (!currentPostId) return;
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) return;
            
            try {
                const response = await fetch(`${POSTS_API}/admin/posts/${currentPostId}/deactivate`, {
                    method: 'PUT',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ');
                    await loadReports();
                    closeReportDetailModal();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∂–∞–ª–æ–±—ã
        async function updateReportStatus(newStatus) {
            if (!currentReportId) return;
            
            try {
                const response = await fetch(`${POSTS_API}/admin/reports/${currentReportId}?new_status=${newStatus}&action=none`, {
                    method: 'PUT',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert('–°—Ç–∞—Ç—É—Å –∂–∞–ª–æ–±—ã –æ–±–Ω–æ–≤–ª–µ–Ω');
                    await loadReports();
                    await loadPendingReportsCount();
                    closeReportDetailModal();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏—Ö
        document.getElementById('reportsModal').addEventListener('click', (e) => {
            if (e.target.id === 'reportsModal') {
                closeReportsModal();
            }
        });

        document.getElementById('reportDetailModal').addEventListener('click', (e) => {
            if (e.target.id === 'reportDetailModal') {
                closeReportDetailModal();
            }
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω-–¥–æ—Å—Ç—É–ø –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∂–∞–ª–æ–± –µ—Å–ª–∏ –∞–¥–º–∏–Ω
        {% if user and (user.user_type == 'admin' or user.user_type == 'support') %}
        loadPendingReportsCount();
        {% endif %}
    </script>

</body>
</html>
