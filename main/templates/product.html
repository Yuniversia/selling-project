<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacBook Air M2 - Lais</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/styles2.css') }}">
</head>
<body>

    <header class="header-fixed">
        <div class="nav-container">
            <a href="/" class="logo">lais</a>
            <div class="header-controls">
                <a href="/" class="btn btn-outline">–ù–∞–∑–∞–¥</a>
            </div>
        </div>
    </header>

    <main class="main-container">
        <!-- Image Modal -->
        <div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; align-items: center; justify-content: center; padding: 20px;">
            <button id="closeModal" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 32px; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">√ó</button>
            <button id="prevImage" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; font-size: 32px; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">‚Äπ</button>
            <button id="nextImage" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; font-size: 32px; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">‚Ä∫</button>
            <img id="modalImage" src="" alt="Full size" style="max-width: 90%; max-height: 90%; object-fit: contain;">
            <div id="imageCounter" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; font-size: 14px; background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px;"></div>
        </div>

        <div class="product-page-layout">
            
            <div class="gallery-container">
                <div class="main-image" style="display: flex; align-items: center; justify-content: center; color: #999;">
                    <img id="mainProductImage" src="" alt="–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞" style="max-width: 100%; max-height: 400px; aspect-ratio: 4/3; object-fit: contain; display: none;">
                    <svg id="placeholderImage" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                </div>
                <div class="thumbs" id="thumbnailsContainer">
                    <div class="thumb active" data-index="0"></div>
                </div>
            </div>

            <div class="info-container">
                <div style="font-size: 13px; color: var(--color-text-light); margin-bottom: 8px;" id="breadcrumb">iPhone</div>
                <h1 id="productTitle">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</h1>
                <div id="viewsInfo" style="font-size: 13px; color: var(--color-text-light); margin-bottom: 15px; display: none;">
                    üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: <span id="viewCount">0</span> | 
                    <span id="statusBadge" style="color: #4CAF50;">‚úì –ê–∫—Ç–∏–≤–Ω–æ</span>
                </div>

                <div style="background: #fff; padding: 20px; border-radius: 16px; border: 1px solid var(--color-border); margin-top: 20px;">
                    <h3 style="margin-bottom: 10px;">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–∞</h3>
                    <p id="productDescription" style="color: var(--color-text); line-height: 1.6; font-size: 15px;">
                        –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...
                    </p>
                </div>

                <div style="margin-top: 30px; display: flex; align-items: center; gap: 15px;">
                    <div id="authorAvatar" style="width: 50px; height: 50px; background: #e1e1e1; border-radius: 50%; display: none;"></div>
                    <div>
                        <div id="authorName" style="font-weight: 600;">–î–º–∏—Ç—Ä–∏–π –ö.</div>
                        <div id="authorDate" style="font-size: 13px; color: var(--color-text-light);">–ù–∞ Lais —Å 2021</div>
                    </div>
                    <button class="btn btn-outline" style="margin-left: auto;">–ù–∞–ø–∏—Å–∞—Ç—å</button>
                </div>

                <div style="margin-top: 20px;">

                    <button id="BuyButon" style="width: 100%; padding-top: 20px; padding-bottom: 20px;"  class="btn btn-primary">–ö—É–ø–∏—Ç—å</button>

                </div>


                <div class="specs-list" id="specsList">
                    <div class="spec-row">
                        <span class="spec-label">–ú–æ–¥–µ–ª—å</span>
                        <span class="spec-value" id="specModel">‚Äî</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">–ü–∞–º—è—Ç—å</span>
                        <span class="spec-value" id="specMemory">‚Äî</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">–¶–≤–µ—Ç</span>
                        <span class="spec-value" id="specColor">‚Äî</span>
                    </div>
                    <div class="spec-row" id="activatedRow">
                        <span class="spec-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ</span>
                        <span class="spec-value" id="specCondition">‚Äî</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞—Ç–∞—Ä–µ–∏</span>
                        <span class="spec-value" id="specBattery">‚Äî</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">IMEI</span>
                        <span class="spec-value" id="specIMEI">‚Äî</span>
                    </div>
                    <div class="spec-row" id="fmiRow" >
                        <span class="spec-label">–°—Ç–∞—Ç—É—Å FMI</span>
                        <span class="spec-value" id="specFMI">‚Äî</span>
                    </div>
                    <div class="spec-row" id="icloudRow">
                        <span class="spec-label">–ü—Ä–∏–≤—è–∑–∫–∞ iCloud</span>
                        <span class="spec-value" id="specICloud">‚Äî</span>
                    </div>
                    <div class="spec-row" id="simlockRow">
                        <span class="spec-label">Sim lock</span>
                        <span class="spec-value" id="specSimlock">‚Äî</span>
                    </div>
                    <div class="spec-row" id="activatedRow">
                        <span class="spec-label">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</span>
                        <span class="spec-value" id="specActivated">‚Äî</span>
                    </div>
                </div>

                <div style="background: #fff; padding: 20px; border-radius: 16px; border: 1px solid var(--color-border);">
                    <h3 style="margin-bottom: 10px;">–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</h3>
                    <div class="checkbox-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <label class="check-item"><input type="checkbox" id="cb_original_box" disabled> –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ—Ä–æ–±–∫–∞</label>
                        <label class="check-item"><input type="checkbox" id="cb_charger" disabled> –ó–∞—Ä—è–¥–Ω—ã–π –±–ª–æ–∫</label>
                        <label class="check-item"><input type="checkbox" id="cb_cable" disabled> –ö–∞–±–µ–ª—å</label>
                        <label class="check-item"><input type="checkbox" id="cb_receipt" disabled> –ß–µ–∫ –æ –ø–æ–∫—É–ø–∫–µ</label>
                        <label class="check-item"><input type="checkbox" id="cb_warranty" disabled> –ì–∞—Ä–∞–Ω—Ç–∏—è</label>
                    </div>
                </div>

                
            </div>

        </div>
    </main>

    <script>
        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ—Å—Ç–∞ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        let currentImages = [];

        async function loadPostData() {
            if (!postId) {
                console.error('Post ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL');
                document.getElementById('productTitle').textContent = '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω';
                return;
            }

            try {
                console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞ —Å ID: ${postId}`);
                const response = await fetch(`http://localhost:3000/api/v1/iphone?id=${postId}`);
                
                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Å—Ç–∞:', response.status);
                    document.getElementById('productTitle').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞';
                    return;
                }

                const postData = await response.json();
                console.log('–î–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞ –ø–æ–ª—É—á–µ–Ω—ã:', postData);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å—Ç–µ
                updateProductDisplay(postData);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–µ
                if (postData.author_id) {
                    await loadAuthorInfo(postData.author_id);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('productTitle').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            }
        }

        function updateProductDisplay(postData) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            const model = postData.model || 'iPhone';
            document.getElementById('productTitle').textContent = model;
            document.getElementById('breadcrumb').textContent = `iPhone / ${model}`;

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –∏ —Å—Ç–∞—Ç—É—Å
            document.getElementById('viewCount').textContent = postData.view_count || 0;
            document.getElementById('viewsInfo').style.display = 'block';
            
            if (!postData.active) {
                document.getElementById('statusBadge').textContent = '‚úó –ù–µ–∞–∫—Ç–∏–≤–Ω–æ';
                document.getElementById('statusBadge').style.color = '#f44336';
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–µ–∫–∏
            const specs = {
                'specModel': postData.model || '‚Äî',
                'specMemory': postData.memory || '‚Äî',
                'specColor': postData.color || '‚Äî',
                'specBattery': postData.batery ? `${postData.batery}%` : '‚Äî',
                'specIMEI': postData.imei || '‚Äî',
                'specSerial': postData.serial_number || '‚Äî'
            };

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–µ —Å–ø–µ–∫–∏
            Object.entries(specs).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ø–µ–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
            if (postData.fmi !== null && postData.fmi !== undefined) {
                document.getElementById('specFMI').textContent = postData.fmi ? '–í –ø–æ–∏—Å–∫–µ' : '–ß–∏—Å—Ç—ã–π';
            }

            if (postData.icloud_pair !== null && postData.icloud_pair !== undefined) {
                document.getElementById('specICloud').textContent = postData.icloud_pair ? '–ü—Ä–∏–≤—è–∑–∞–Ω' : '–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
            }

            if (postData.simlock !== null && postData.simlock !== undefined) {
                document.getElementById('specSimlock').textContent = postData.simlock ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–ù–µ—Ç';
            }

            if (postData.activated !== null && postData.activated !== undefined) {
                document.getElementById('specActivated').textContent = postData.activated ? '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω';
            }

            document.getElementById("BuyButon").innerHTML = `–ö—É–ø–∏—Ç—å –∑–∞ ${postData.price || '0'} eur`;
            document.getElementById('specCondition').textContent = postData.condition || '‚Äî';

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é
            document.getElementById('cb_original_box').checked = postData.has_original_box || false;
            document.getElementById('cb_charger').checked = postData.has_charger || false;
            document.getElementById('cb_cable').checked = postData.has_cable || false;
            document.getElementById('cb_receipt').checked = postData.has_receipt || false;
            document.getElementById('cb_warranty').checked = postData.has_warranty || false;

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
            document.getElementById('productDescription').textContent = postData.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
            if (postData.images_url) {
                currentImages = postData.images_url.split(',').filter(url => url.trim());
                renderGallery();
            }
        }

        function renderGallery() {
            if (currentImages.length === 0) {
                document.getElementById('mainProductImage').style.display = 'none';
                document.getElementById('placeholderImage').style.display = 'block';
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é
            const mainImage = document.getElementById('mainProductImage');
            mainImage.src = currentImages[0];
            mainImage.style.display = 'block';
            document.getElementById('placeholderImage').style.display = 'none';

            // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã
            const thumbsContainer = document.getElementById('thumbnailsContainer');
            thumbsContainer.innerHTML = '';

            currentImages.forEach((imageUrl, index) => {
                const thumb = document.createElement('div');
                thumb.className = `thumb ${index === 0 ? 'active' : ''}`;
                thumb.style.backgroundImage = `url('${imageUrl}')`;
                thumb.style.backgroundSize = 'cover';
                thumb.style.backgroundPosition = 'center';
                thumb.dataset.index = index;

                thumb.addEventListener('click', () => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
                    document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');

                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ
                    document.getElementById('mainProductImage').src = imageUrl;
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
                    openImageModal(imageUrl, index);
                });

                thumbsContainer.appendChild(thumb);
            });
        }

        async function loadAuthorInfo(authorId) {
            try {
                console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–µ —Å ID: ${authorId}`);
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–µ –∏–∑ auth —Å–µ—Ä–≤–∏—Å–∞
                const response = await fetch(`http://localhost:8000/auth/user?id=${authorId}`);
                
                if (response.ok) {
                    const authorData = await response.json();
                    console.log('–î–∞–Ω–Ω—ã–µ –æ–± –∞–≤—Ç–æ—Ä–µ –ø–æ–ª—É—á–µ–Ω—ã:', authorData);
                    
                    document.getElementById('authorName').textContent = 
                        authorData.name || authorData.username || '–ü—Ä–æ–¥–∞–≤–µ—Ü';
                    
                    if (authorData.created_at) {
                        const date = new Date(authorData.created_at);
                        const year = date.getFullYear();
                        document.getElementById('authorDate').textContent = 
                            `–ù–∞ Lais —Å ${year}`;
                    }

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (authorData.avatar_url) {
                        document.getElementById('authorAvatar').style.backgroundImage = 
                            `url('${authorData.avatar_url}')`;
                        document.getElementById('authorAvatar').style.backgroundSize = 'cover';
                        document.getElementById('authorAvatar').style.backgroundPosition = 'center';
                    }
                    document.getElementById('authorAvatar').style.display = 'block';
                    
                } else {
                    // –ï—Å–ª–∏ endpoint –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º default view
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–µ');
                    document.getElementById('authorAvatar').style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ—Ä–µ:', error);
                // –í—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É —Å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                document.getElementById('authorAvatar').style.display = 'block';
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        let currentModalIndex = 0;
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const imageCounter = document.getElementById('imageCounter');
        const closeModalBtn = document.getElementById('closeModal');
        const prevImageBtn = document.getElementById('prevImage');
        const nextImageBtn = document.getElementById('nextImage');

        function openImageModal(imageUrl, index) {
            currentModalIndex = index;
            modalImage.src = imageUrl;
            imageCounter.textContent = `${index + 1} / ${currentImages.length}`;
            imageModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            imageModal.style.display = 'none';
            document.body.style.overflow = '';
        }

        function showPrevImage() {
            currentModalIndex = (currentModalIndex - 1 + currentImages.length) % currentImages.length;
            modalImage.src = currentImages[currentModalIndex];
            imageCounter.textContent = `${currentModalIndex + 1} / ${currentImages.length}`;
        }

        function showNextImage() {
            currentModalIndex = (currentModalIndex + 1) % currentImages.length;
            modalImage.src = currentImages[currentModalIndex];
            imageCounter.textContent = `${currentModalIndex + 1} / ${currentImages.length}`;
        }

        closeModalBtn.addEventListener('click', closeImageModal);
        prevImageBtn.addEventListener('click', showPrevImage);
        nextImageBtn.addEventListener('click', showNextImage);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeImageModal();
            }
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫–ª–∞–≤–∏—à–∞–º–∏
        document.addEventListener('keydown', (e) => {
            if (imageModal.style.display === 'flex') {
                if (e.key === 'Escape') closeImageModal();
                if (e.key === 'ArrowLeft') showPrevImage();
                if (e.key === 'ArrowRight') showNextImage();
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('mainProductImage').addEventListener('click', () => {
            const activeThumb = document.querySelector('.thumb.active');
            const activeIndex = activeThumb ? parseInt(activeThumb.dataset.index) : 0;
            openImageModal(currentImages[activeIndex], activeIndex);
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', loadPostData);
    </script>