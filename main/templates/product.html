<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacBook Air M2 - Lais</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/styles2.css') }}?v=15">
    <script src="{{ url_for('static', path='/cache-manager.js') }}?v=15"></script>
    <script src="{{ url_for('static', path='/notifications.js') }}?v=15" defer></script>
    <script src="{{ url_for('static', path='/notification-prompt.js') }}?v=15" defer></script>
    <script src="{{ url_for('static', path='/chat.js') }}?v=15" defer></script>
</head>
<body>

    <header class="header-fixed">
        <div class="nav-container">
            <a href="/" class="logo">lais</a>
            <div class="header-controls">
                <a href="/" class="btn btn-outline">–ù–∞–∑–∞–¥</a>
            </div>
        </div>
    </header>

    <main class="main-container">
        <!-- Image Modal -->
        <div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; align-items: center; justify-content: center; padding: 20px;">
            <button id="closeModal" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 32px; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">√ó</button>
            <button id="prevImage" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; font-size: 32px; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">‚Äπ</button>
            <button id="nextImage" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; font-size: 32px; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">‚Ä∫</button>
            <img id="modalImage" src="" alt="Full size" style="max-width: 90%; max-height: 90%; object-fit: contain;">
            <div id="imageCounter" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; font-size: 14px; background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px;"></div>
        </div>

        <!-- Purchase Modal -->
        <div id="purchaseModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <h2 style="margin-bottom: 20px;">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏</h2>
                <form id="purchaseForm">
                    <div class="form-group">
                        <label class="label">–ò–º—è *</label>
                        <input type="text" id="buyerName" class="input" required>
                    </div>
                    <div class="form-group">
                        <label class="label">–§–∞–º–∏–ª–∏—è *</label>
                        <input type="text" id="buyerSurname" class="input" required>
                    </div>
                    <div class="form-group">
                        <label class="label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
                        <input type="tel" id="buyerPhone" class="input" required>
                    </div>
                    <div class="form-group">
                        <label class="label">Email *</label>
                        <input type="email" id="buyerEmail" class="input" required>
                    </div>
                    <div class="form-group">
                        <label class="label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                        <textarea id="deliveryAddress" class="input" rows="3" required></textarea>
                    </div>
                    <div id="purchaseError" style="color: #ff3b30; margin-bottom: 16px; display: none;"></div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn btn-outline" style="flex: 1;" onclick="closePurchaseModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;" id="submitPurchaseBtn">–ö—É–ø–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Report Modal -->
        <div id="reportModal" class="modal">
            <div class="modal-content" style="max-width: 450px;">
                <h2 style="margin-bottom: 20px;">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
                <p style="color: var(--color-text-light); font-size: 14px; margin-bottom: 20px;">
                    –í–∞—à–∞ –∂–∞–ª–æ–±–∞ –±—É–¥–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É.
                </p>
                <form id="reportForm">
                    <div class="form-group">
                        <label class="label">–ü—Ä–∏—á–∏–Ω–∞ –∂–∞–ª–æ–±—ã *</label>
                        <select id="reportReason" class="input" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É</option>
                            <option value="–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ">–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ</option>
                            <option value="–ü–æ–¥–¥–µ–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ">–ü–æ–¥–¥–µ–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>
                            <option value="–£–∫—Ä–∞–¥–µ–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω">–£–∫—Ä–∞–¥–µ–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω</option>
                            <option value="–ù–µ–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">–ù–µ–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</option>
                            <option value="–î—É–±–ª–∏–∫–∞—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è">–î—É–±–ª–∏–∫–∞—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è</option>
                            <option value="–ù–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç">–ù–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</option>
                            <option value="–°–ø–∞–º">–°–ø–∞–º</option>
                            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea id="reportDetails" class="input" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ–±–ª–µ–º—É..." maxlength="500"></textarea>
                        <div style="font-size: 12px; color: var(--color-text-light); margin-top: 4px;">
                            <span id="reportDetailsCount">0</span>/500 —Å–∏–º–≤–æ–ª–æ–≤
                        </div>
                    </div>
                    <div id="reportSuccess" style="color: #34c759; margin-bottom: 16px; display: none; padding: 12px; background: #e8f5e9; border-radius: 8px; text-align: center;">
                        ‚úì –ñ–∞–ª–æ–±–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞
                    </div>
                    <div id="reportError" style="color: #ff3b30; margin-bottom: 16px; display: none; padding: 12px; background: #ffebee; border-radius: 8px; text-align: center;"></div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn btn-outline" style="flex: 1;" onclick="closeReportModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1; background: #ff3b30;" id="submitReportBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="product-page-layout">
            
            <div class="gallery-container">
                <div class="main-image" style="display: flex; align-items: center; justify-content: center; color: #999; cursor: pointer;">
                    <img id="mainProductImage" src="" alt="–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞" style="width: 100%; height: 100%; object-fit: contain; display: none;">
                    <svg id="placeholderImage" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                </div>
                <div class="thumbs" id="thumbnailsContainer">
                    <div class="thumb active" data-index="0"></div>
                </div>
            </div>

            <div class="info-container">
                <div style="font-size: 13px; color: var(--color-text-light); margin-bottom: 8px;" id="breadcrumb">iPhone</div>
                <h1 id="productTitle">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</h1>
                <div id="viewsInfo" style="font-size: 13px; color: var(--color-text-light); margin-bottom: 15px; display: none;">
                    üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: <span id="viewCount">0</span> | 
                    <span id="statusBadge" style="color: #4CAF50;">‚úì –ê–∫—Ç–∏–≤–Ω–æ</span>
                </div>

                <div style="background: #fff; padding: 20px; border-radius: 16px; border: 1px solid var(--color-border); margin-top: 20px;">
                    <h3 style="margin-bottom: 10px;">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–∞</h3>
                    <p id="productDescription" style="color: var(--color-text); line-height: 1.6; font-size: 15px;">
                        –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...
                    </p>
                </div>

                <div style="margin-top: 30px; display: flex; align-items: center; gap: 15px;">
                    <div id="authorAvatar" style="width: 50px; height: 50px; background: #e1e1e1; border-radius: 50%; display: none;"></div>
                    <div>
                        <div id="authorName" style="font-weight: 600;">–î–º–∏—Ç—Ä–∏–π –ö.</div>
                        <div id="authorDate" style="font-size: 13px; color: var(--color-text-light);">–ù–∞ Lais —Å 2021</div>
                    </div>
                    <button id="openChatBtn" class="btn btn-primary" style="margin-left: auto;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        –ù–∞–ø–∏—Å–∞—Ç—å
                    </button>
                </div>

                <div style="margin-top: 20px;">
                    <button id="BuyButon" style="width: 100%; padding-top: 20px; padding-bottom: 20px;"  class="btn btn-primary">–ö—É–ø–∏—Ç—å</button>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –∂–∞–ª–æ–±—ã (–Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–∞—è) -->
                <div style="margin-top: 15px; text-align: center;">
                    <button id="reportBtn" class="btn-report" style="background: none; border: none; color: #999; font-size: 13px; cursor: pointer; padding: 8px 16px; border-radius: 6px; transition: all 0.2s;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
                    </button>
                </div>

                <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (—Ç–æ–ª—å–∫–æ –¥–ª—è admin/support) -->
                {% if user and (user.user_type == 'admin' or user.user_type == 'support') %}
                <div id="adminControls" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
                    <div style="color: white; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2">
                            <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        –ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="deactivatePostBtn" class="btn btn-outline" style="flex: 1; background: white; color: #ff3b30; border: none; font-weight: 600;">
                            –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button id="activatePostBtn" class="btn btn-outline" style="flex: 1; background: white; color: #34c759; border: none; font-weight: 600; display: none;">
                            –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                </div>
                {% endif %}


                <div class="specs-list" id="specsList">
                    <div class="spec-row">
                        <span class="spec-label">–ú–æ–¥–µ–ª—å</span>
                        <span class="spec-value" id="specModel">‚Äî</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">–ü–∞–º—è—Ç—å</span>
                        <span class="spec-value" id="specMemory">‚Äî</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">–¶–≤–µ—Ç</span>
                        <span class="spec-value" id="specColor">‚Äî</span>
                    </div>
                    <div class="spec-row" id="activatedRow">
                        <span class="spec-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ</span>
                        <span class="spec-value" id="specCondition">‚Äî</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞—Ç–∞—Ä–µ–∏</span>
                        <span class="spec-value" id="specBattery">‚Äî</span>
                    </div>
                    <div class="spec-row">
                        <span class="spec-label">IMEI</span>
                        <span class="spec-value" id="specIMEI">‚Äî</span>
                    </div>
                    <div class="spec-row" id="fmiRow" >
                        <span class="spec-label">–°—Ç–∞—Ç—É—Å FMI</span>
                        <span class="spec-value" id="specFMI">‚Äî</span>
                    </div>
                    <div class="spec-row" id="icloudRow">
                        <span class="spec-label">–ü—Ä–∏–≤—è–∑–∫–∞ iCloud</span>
                        <span class="spec-value" id="specICloud">‚Äî</span>
                    </div>
                    <div class="spec-row" id="simlockRow">
                        <span class="spec-label">Sim lock</span>
                        <span class="spec-value" id="specSimlock">‚Äî</span>
                    </div>
                    <div class="spec-row" id="activatedRow">
                        <span class="spec-label">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</span>
                        <span class="spec-value" id="specActivated">‚Äî</span>
                    </div>
                </div>

                <div style="background: #fff; padding: 20px; border-radius: 16px; border: 1px solid var(--color-border);">
                    <h3 style="margin-bottom: 10px;">–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</h3>
                    <div class="checkbox-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <label class="check-item"><input type="checkbox" id="cb_original_box" disabled> –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ—Ä–æ–±–∫–∞</label>
                        <label class="check-item"><input type="checkbox" id="cb_charger" disabled> –ó–∞—Ä—è–¥–Ω—ã–π –±–ª–æ–∫</label>
                        <label class="check-item"><input type="checkbox" id="cb_cable" disabled> –ö–∞–±–µ–ª—å</label>
                        <label class="check-item"><input type="checkbox" id="cb_receipt" disabled> –ß–µ–∫ –æ –ø–æ–∫—É–ø–∫–µ</label>
                        <label class="check-item"><input type="checkbox" id="cb_warranty" disabled> –ì–∞—Ä–∞–Ω—Ç–∏—è</label>
                    </div>
                </div>

                
            </div>

        </div>
    </main>

    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ cachedFetch
        console.log('[Product] cachedFetch –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof window.cachedFetch);
        console.log('[Product] cacheManager –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof window.cacheManager);
        
        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ—Å—Ç–∞ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        let currentImages = [];

        let currentPostData = null; // –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ

        async function loadPostData() {
            if (!postId) {
                console.error('Post ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL');
                document.getElementById('productTitle').textContent = '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω';
                return;
            }

            try {
                console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞ —Å ID: ${postId}`);
                // –ö–µ—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–∞ 10 –º–∏–Ω—É—Ç
                const response = await cachedFetch(
                    `http://localhost:3000/api/v1/iphone?id=${postId}`,
                    {},
                    10 * 60 * 1000
                );
                
                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Å—Ç–∞:', response.status);
                    document.getElementById('productTitle').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞';
                    return;
                }

                currentPostData = await response.json();
                console.log('–î–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞ –ø–æ–ª—É—á–µ–Ω—ã:', currentPostData);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å—Ç–µ
                updateProductDisplay(currentPostData);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–µ
                if (currentPostData.author_id) {
                    await loadAuthorInfo(currentPostData.author_id);
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –ø–æ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω
                updateAdminControls();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('productTitle').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            }
        }

        function updateProductDisplay(postData) {
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
            function formatMemory(memoryGB) {
                if (!memoryGB) return '‚Äî';
                if (memoryGB >= 1024) {
                    return `${memoryGB / 1024}TB`;
                }
                return `${memoryGB}GB`;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            const model = postData.model || 'iPhone';
            document.getElementById('productTitle').textContent = model;
            document.getElementById('breadcrumb').textContent = `iPhone / ${model}`;

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –∏ —Å—Ç–∞—Ç—É—Å
            document.getElementById('viewCount').textContent = postData.view_count || 0;
            document.getElementById('viewsInfo').style.display = 'block';
            
            if (!postData.active) {
                document.getElementById('statusBadge').textContent = '‚úó –ù–µ–∞–∫—Ç–∏–≤–Ω–æ';
                document.getElementById('statusBadge').style.color = '#f44336';
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–µ–∫–∏
            const specs = {
                'specModel': postData.model || '‚Äî',
                'specMemory': formatMemory(postData.memory),
                'specColor': postData.color || '‚Äî',
                'specBattery': postData.batery ? `${postData.batery}%` : '‚Äî',
                'specIMEI': postData.imei || '‚Äî',
                'specSerial': postData.serial_number || '‚Äî'
            };

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–µ —Å–ø–µ–∫–∏
            Object.entries(specs).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ø–µ–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
            if (postData.fmi !== null && postData.fmi !== undefined) {
                document.getElementById('specFMI').textContent = postData.fmi ? '–í –ø–æ–∏—Å–∫–µ' : '–ß–∏—Å—Ç—ã–π';
            }

            if (postData.icloud_pair !== null && postData.icloud_pair !== undefined) {
                document.getElementById('specICloud').textContent = postData.icloud_pair ? '–ü—Ä–∏–≤—è–∑–∞–Ω' : '–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
            }

            if (postData.simlock !== null && postData.simlock !== undefined) {
                document.getElementById('specSimlock').textContent = postData.simlock ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–ù–µ—Ç';
            }

            if (postData.activated !== null && postData.activated !== undefined) {
                document.getElementById('specActivated').textContent = postData.activated ? '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω';
            }

            document.getElementById("BuyButon").innerHTML = `–ö—É–ø–∏—Ç—å –∑–∞ ${postData.price || '0'} eur`;
            document.getElementById('specCondition').textContent = postData.condition || '‚Äî';

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é
            document.getElementById('cb_original_box').checked = postData.has_original_box || false;
            document.getElementById('cb_charger').checked = postData.has_charger || false;
            document.getElementById('cb_cable').checked = postData.has_cable || false;
            document.getElementById('cb_receipt').checked = postData.has_receipt || false;
            document.getElementById('cb_warranty').checked = postData.has_warranty || false;

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
            document.getElementById('productDescription').textContent = postData.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
            if (postData.images_url) {
                currentImages = postData.images_url.split(',').filter(url => url.trim());
                renderGallery();
            }
        }

        function renderGallery() {
            if (currentImages.length === 0) {
                document.getElementById('mainProductImage').style.display = 'none';
                document.getElementById('placeholderImage').style.display = 'block';
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é
            const mainImage = document.getElementById('mainProductImage');
            mainImage.src = currentImages[0];
            mainImage.style.display = 'block';
            document.getElementById('placeholderImage').style.display = 'none';

            // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã
            const thumbsContainer = document.getElementById('thumbnailsContainer');
            thumbsContainer.innerHTML = '';

            currentImages.forEach((imageUrl, index) => {
                const thumb = document.createElement('div');
                thumb.className = `thumb ${index === 0 ? 'active' : ''}`;
                thumb.style.backgroundImage = `url('${imageUrl}')`;
                thumb.style.backgroundSize = 'cover';
                thumb.style.backgroundPosition = 'center';
                thumb.dataset.index = index;

                thumb.addEventListener('click', () => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
                    document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');

                    // –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ, –ë–ï–ó –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    document.getElementById('mainProductImage').src = imageUrl;
                });

                thumbsContainer.appendChild(thumb);
            });
        }

        async function loadAuthorInfo(authorId) {
            try {
                console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–µ —Å ID: ${authorId}`);
                // –ö–µ—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∞ –Ω–∞ 15 –º–∏–Ω—É—Ç
                const response = await cachedFetch(
                    `http://localhost:8000/auth/user?id=${authorId}`,
                    {},
                    15 * 60 * 1000
                );
                
                if (response.ok) {
                    const authorData = await response.json();
                    console.log('–î–∞–Ω–Ω—ã–µ –æ–± –∞–≤—Ç–æ—Ä–µ –ø–æ–ª—É—á–µ–Ω—ã:', authorData);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞
                    currentAuthorData = authorData;
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è: "–ò–º—è –§–∞–º–∏–ª–∏—è" –∏–ª–∏ username
                    let displayName = authorData.username || '–ü—Ä–æ–¥–∞–≤–µ—Ü';
                    if (authorData.name && authorData.surname) {
                        displayName = `${authorData.name} ${authorData.surname}`;
                    } else if (authorData.name) {
                        displayName = authorData.name;
                    }
                    document.getElementById('authorName').textContent = displayName;
                    
                    if (authorData.joined_date) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º joined_date –∏–∑ API (—É–∂–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ)
                        const dateParts = authorData.joined_date.split('.');
                        const year = dateParts[2];
                        document.getElementById('authorDate').textContent = 
                            `–ù–∞ Lais —Å ${year}`;
                    }

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (authorData.avatar_url) {
                        document.getElementById('authorAvatar').style.backgroundImage = 
                            `url('${authorData.avatar_url}')` || `url('https://ui-avatars.com/api/?name=${displayName}&background=0D8ABC&color=fff&size=256')`;
                        document.getElementById('authorAvatar').style.backgroundSize = 'cover';
                        document.getElementById('authorAvatar').style.backgroundPosition = 'center';
                    }
                    document.getElementById('authorAvatar').style.display = 'block';
                    
                } else {
                    // –ï—Å–ª–∏ endpoint –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º default view
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–µ');
                    document.getElementById('authorAvatar').style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ—Ä–µ:', error);
                // –í—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É —Å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                document.getElementById('authorAvatar').style.display = 'block';
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        let currentModalIndex = 0;
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const imageCounter = document.getElementById('imageCounter');
        const closeModalBtn = document.getElementById('closeModal');
        const prevImageBtn = document.getElementById('prevImage');
        const nextImageBtn = document.getElementById('nextImage');

        function openImageModal(imageUrl, index) {
            currentModalIndex = index;
            modalImage.src = imageUrl;
            imageCounter.textContent = `${index + 1} / ${currentImages.length}`;
            imageModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            imageModal.style.display = 'none';
            document.body.style.overflow = '';
        }

        function showPrevImage() {
            currentModalIndex = (currentModalIndex - 1 + currentImages.length) % currentImages.length;
            modalImage.src = currentImages[currentModalIndex];
            imageCounter.textContent = `${currentModalIndex + 1} / ${currentImages.length}`;
        }

        function showNextImage() {
            currentModalIndex = (currentModalIndex + 1) % currentImages.length;
            modalImage.src = currentImages[currentModalIndex];
            imageCounter.textContent = `${currentModalIndex + 1} / ${currentImages.length}`;
        }

        closeModalBtn.addEventListener('click', closeImageModal);
        prevImageBtn.addEventListener('click', showPrevImage);
        nextImageBtn.addEventListener('click', showNextImage);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeImageModal();
            }
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫–ª–∞–≤–∏—à–∞–º–∏
        document.addEventListener('keydown', (e) => {
            if (imageModal.style.display === 'flex') {
                if (e.key === 'Escape') closeImageModal();
                if (e.key === 'ArrowLeft') showPrevImage();
                if (e.key === 'ArrowRight') showNextImage();
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('mainProductImage').addEventListener('click', () => {
            if (currentImages.length === 0) return;
            const activeThumb = document.querySelector('.thumb.active');
            const activeIndex = activeThumb ? parseInt(activeThumb.dataset.index) : 0;
            openImageModal(currentImages[activeIndex], activeIndex);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–∫ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–ª–∞–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ placeholder)
        document.querySelector('.main-image').addEventListener('click', () => {
            if (currentImages.length > 0) {
                const activeThumb = document.querySelector('.thumb.active');
                const activeIndex = activeThumb ? parseInt(activeThumb.dataset.index) : 0;
                openImageModal(currentImages[activeIndex], activeIndex);
            }
        });

        // –°–∫—Ä–æ–ª–ª –º–∏–Ω–∏–∞—Ç—é—Ä –∫–æ–ª—ë—Å–∏–∫–æ–º –º—ã—à–∏
        const thumbsScrollContainer = document.getElementById('thumbnailsContainer');
        
        thumbsScrollContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            thumbsScrollContainer.scrollLeft += e.deltaY;
        });

        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –º—ã—à–∫–æ–π –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ –º–∏–Ω–∏–∞—Ç—é—Ä
        let isDown = false;
        let startX;
        let scrollLeft;

        thumbsScrollContainer.addEventListener('mousedown', (e) => {
            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –º–∏–Ω–∏–∞—Ç—é—Ä—É, –Ω–µ –Ω–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            if (e.target.classList.contains('thumb')) {
                return;
            }
            isDown = true;
            thumbsScrollContainer.style.cursor = 'grabbing';
            startX = e.pageX - thumbsScrollContainer.offsetLeft;
            scrollLeft = thumbsScrollContainer.scrollLeft;
        });

        thumbsScrollContainer.addEventListener('mouseleave', () => {
            isDown = false;
            thumbsScrollContainer.style.cursor = 'default';
        });

        thumbsScrollContainer.addEventListener('mouseup', () => {
            isDown = false;
            thumbsScrollContainer.style.cursor = 'default';
        });

        thumbsScrollContainer.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - thumbsScrollContainer.offsetLeft;
            const walk = (x - startX) * 2; // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–∫—Ä–æ–ª–ª–∞
            thumbsScrollContainer.scrollLeft = scrollLeft - walk;
        });

        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞
        let currentAuthorData = null;

        function openPurchaseModal() {
            document.getElementById('purchaseModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            loadUserProfileData();
        }

        function closePurchaseModal() {
            document.getElementById('purchaseModal').classList.remove('active');
            document.body.style.overflow = '';
            document.getElementById('purchaseError').style.display = 'none';
        }

        function openContactModal() {
            if (currentAuthorData) {
                document.getElementById('sellerPhone').textContent = currentAuthorData.phone || '–ù–µ —É–∫–∞–∑–∞–Ω';
                document.getElementById('sellerEmail').textContent = currentAuthorData.email || '–ù–µ —É–∫–∞–∑–∞–Ω';
            }
            document.getElementById('contactModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        async function loadUserProfileData() {
            try {
                // –ö–µ—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞ 5 –º–∏–Ω—É—Ç
                const response = await cachedFetch('http://localhost:8000/auth/me', {
                    credentials: 'include'
                }, 5 * 60 * 1000);
                
                if (response.ok) {
                    const userData = await response.json();
                    
                    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                    if (userData.name) document.getElementById('buyerName').value = userData.name;
                    if (userData.surname) document.getElementById('buyerSurname').value = userData.surname;
                    if (userData.phone) document.getElementById('buyerPhone').value = userData.phone;
                    if (userData.email) document.getElementById('buyerEmail').value = userData.email;
                }
            } catch (error) {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –ø–æ–∫—É–ø–∫–∏
        document.getElementById('purchaseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitPurchaseBtn');
            const errorDiv = document.getElementById('purchaseError');
            
            submitBtn.disabled = true;
            submitBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            errorDiv.style.display = 'none';
            
            const purchaseData = {
                post_id: parseInt(postId),
                buyer_name: document.getElementById('buyerName').value,
                buyer_surname: document.getElementById('buyerSurname').value,
                buyer_phone: document.getElementById('buyerPhone').value,
                buyer_email: document.getElementById('buyerEmail').value,
                delivery_address: document.getElementById('deliveryAddress').value
            };
            
            try {
                const response = await fetch('http://localhost:3000/api/v1/bought/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(purchaseData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('–ü–æ–∫—É–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞:', result);
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    closePurchaseModal();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    alert('–ü–æ–∫—É–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É.');
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞ (–æ–Ω —Å—Ç–∞–Ω–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º)
                    await loadPostData();
                    
                } else {
                    const error = await response.json();
                    errorDiv.textContent = error.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –ø–æ–∫—É–ø–∫–∏';
                    errorDiv.style.display = 'block';
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                errorDiv.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '–ö—É–ø–∏—Ç—å';
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('BuyButon').addEventListener('click', openPurchaseModal);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —á–∞—Ç–∞
        document.getElementById('openChatBtn').addEventListener('click', async () => {
            if (!postId) {
                alert('ID —Ç–æ–≤–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–æ–¥–∞–≤—Ü–∞ –∏–∑ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const response = await cachedFetch(
                    `http://localhost:3000/api/v1/iphone?id=${postId}`,
                    {},
                    10 * 60 * 1000
                );
                const postData = await response.json();
                
                if (postData.author_id && window.chatManager) {
                    window.chatManager.openChat(postData.author_id, parseInt(postId));
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞');
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏—Ö
        document.getElementById('purchaseModal').addEventListener('click', (e) => {
            if (e.target.id === 'purchaseModal') {
                closePurchaseModal();
            }
        });

        document.getElementById('reportModal').addEventListener('click', (e) => {
            if (e.target.id === 'reportModal') {
                closeReportModal();
            }
        });

        // === –§–£–ù–ö–¶–ò–û–ù–ê–õ –ñ–ê–õ–û–ë ===
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∂–∞–ª–æ–±—ã
        document.getElementById('reportBtn').addEventListener('click', async () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∂–∞–ª–æ–±—É
            try {
                const response = await fetch(`http://localhost:3000/api/v1/report/check/${postId}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.has_reported) {
                        alert('–í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∂–∞–ª–æ–±—É –Ω–∞ —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ');
                        return;
                    }
                }
            } catch (error) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∂–∞–ª–æ–±—ã');
            }
            
            document.getElementById('reportModal').style.display = 'flex';
            document.getElementById('reportSuccess').style.display = 'none';
            document.getElementById('reportError').style.display = 'none';
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∂–∞–ª–æ–±—ã
        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
            document.getElementById('reportForm').reset();
            document.getElementById('reportDetailsCount').textContent = '0';
        }

        // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –≤ textarea
        document.getElementById('reportDetails').addEventListener('input', (e) => {
            document.getElementById('reportDetailsCount').textContent = e.target.value.length;
        });

        // Hover —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∂–∞–ª–æ–±—ã
        const reportBtn = document.getElementById('reportBtn');
        reportBtn.addEventListener('mouseenter', () => {
            reportBtn.style.background = '#f5f5f5';
            reportBtn.style.color = '#ff3b30';
        });
        reportBtn.addEventListener('mouseleave', () => {
            reportBtn.style.background = 'none';
            reportBtn.style.color = '#999';
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –∂–∞–ª–æ–±—ã
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitReportBtn');
            const errorDiv = document.getElementById('reportError');
            const successDiv = document.getElementById('reportSuccess');
            
            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            const reportData = {
                post_id: parseInt(postId),
                reason: document.getElementById('reportReason').value,
                details: document.getElementById('reportDetails').value || null
            };
            
            try {
                const response = await fetch('http://localhost:3000/api/v1/report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(reportData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:', result);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    successDiv.style.display = 'block';
                    document.getElementById('reportForm').style.display = 'none';
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        closeReportModal();
                        document.getElementById('reportForm').style.display = 'block';
                    }, 2000);
                    
                } else {
                    const error = await response.json();
                    errorDiv.textContent = error.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É';
                    errorDiv.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∂–∞–ª–æ–±—ã:', error);
                errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }
        });

        // === –ê–î–ú–ò–ù–°–ö–ê–Ø –ü–ê–ù–ï–õ–¨ ===
        {% if user and (user.user_type == 'admin' or user.user_type == 'support') %}
        
        function updateAdminControls() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –∫–Ω–æ–ø–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å—Ç–∞
            if (currentPostData && currentPostData.active) {
                document.getElementById('deactivatePostBtn').style.display = 'block';
                document.getElementById('activatePostBtn').style.display = 'none';
            } else if (currentPostData) {
                document.getElementById('deactivatePostBtn').style.display = 'none';
                document.getElementById('activatePostBtn').style.display = 'block';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        document.getElementById('deactivatePostBtn')?.addEventListener('click', async () => {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) return;
            
            try {
                const response = await fetch(`http://localhost:3000/api/v1/admin/posts/${postId}/deactivate`, {
                    method: 'PUT',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert('‚úì –û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        document.getElementById('activatePostBtn')?.addEventListener('click', async () => {
            if (!confirm('–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) return;
            
            try {
                const response = await fetch(`http://localhost:3000/api/v1/admin/posts/${postId}/activate`, {
                    method: 'PUT',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert('‚úì –û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        });
        
        {% else %}
        
        function updateAdminControls() {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        }
        
        {% endif %}

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', loadPostData);
    </script>