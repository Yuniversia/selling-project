<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>{{ t.new_ad }}</title>
    <link rel="stylesheet" href="/templates/static/styles2.css?v=16">
    <script>
        // API Configuration - –µ–¥–∏–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç /api/v1/<service>
        const API_V1 = "/api/v1";
        const AUTH_API = `${API_V1}/auth`;
        const POSTS_API = `${API_V1}/posts`;
        console.log('üîß API BASE:', API_V1);
    </script>
    <style>
        .post-container { max-width: 700px; margin: 40px auto; background: #fff; padding: 40px; border-radius: 24px; border: 1px solid var(--color-border); }
        @media(max-width: 768px) { .post-container { margin: 0; border-radius: 0; border: none; padding: 20px; } }
        .hidden-group { display: none; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .photo-upload-zone {
            border: 2px dashed var(--color-border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        .photo-upload-zone:hover {
            border-color: var(--color-primary, #007AFF);
            background: #f0f8ff;
        }
        
        .photo-upload-zone.dragover {
            border-color: var(--color-primary, #007AFF);
            background: #e3f2fd;
        }
        
        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        .photo-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-item .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .photo-item:hover .delete-btn {
            opacity: 1;
        }
        
        .photo-count {
            font-size: 13px;
            color: var(--color-text-light);
            margin-top: 8px;
        }
        
        .photo-count.max {
            color: #f44336;
        }

        /* Progress Modal */
        .progress-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .progress-modal.show {
            display: flex;
        }

        .progress-box {
            background: #fff;
            border-radius: 16px;
            padding: 40px;
            max-width: 300px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .progress-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--color-text);
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007AFF, #0051ba);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            font-size: 14px;
            color: var(--color-text-light);
            margin-bottom: 8px;
        }

        .progress-percent {
            font-size: 20px;
            font-weight: 700;
            color: #007AFF;
        }
    </style>

</head>
<body>

    <header class="header-fixed">
        <div class="nav-container">
            <a href="/" class="logo">lais</a>
            <a href="/" class="btn btn-text">{{ t.cancel_button }}</a>
        </div>
    </header>

    <div class="post-container">
        <h1 style="margin-bottom: 30px;">{{ t.sell_device }}</h1>
        
        <form>
            <!-- <div class="form-group">
                <label class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="catSelect" class="input">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>
                    <option value="iphone">iPhone</option>
                    <option value="macbook">MacBook</option>
                    <option value="ipad">iPad</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div> -->


                        <div id="iphoneBlock" class="hidden-group">
                            <div class="form-group">
                                <label class="label">{{ t.model }}</label>
                                <select id="iphoneModel" class="input">
                                    <option value="">{{ t.select_model }}</option>
                                    <option value="17">iPhone 17</option>
                                    <option value="17plus">iPhone 17 Plus</option>
                                    <option value="17pro">iPhone 17 Pro</option>
                                    <option value="17promax">iPhone 17 Pro Max</option>
                                    <option value="16">iPhone 16</option>
                                    <option value="16plus">iPhone 16 Plus</option>
                                    <option value="16pro">iPhone 16 Pro</option>
                                    <option value="16promax">iPhone 16 Pro Max</option>
                                    <option value="15pro">iPhone 15 Pro</option>
                                    <option value="15promax">iPhone 15 Pro Max</option>
                                    <option value="15">iPhone 15</option>
                                    <option value="14pro">iPhone 14 Pro</option>
                                    <option value="14promax">iPhone 14 Pro Max</option>
                                    <option value="14">iPhone 14</option>
                                    <option value="13pro">iPhone 13 Pro</option>
                                    <option value="13promax">iPhone 13 Pro Max</option>
                                    <option value="13">iPhone 13</option>
                                    <option value="12pro">iPhone 12 Pro</option>
                                    <option value="12promax">iPhone 12 Pro Max</option>
                                    <option value="12">iPhone 12</option>
                                    <option value="11pro">iPhone 11 Pro</option>
                                    <option value="11">iPhone 11</option>
                                    <option value="xsmax">iPhone XS Max</option>
                                    <option value="xs">iPhone XS</option>
                                    <option value="x">iPhone X</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="label">{{ t.imei_label }} <a href="https://support.apple.com/ru-ru/HT204073" target="_blank" title="{{ t.how_to_find }}">‚ùì</a></label>
                                <input id="imei-input" type="text" class="input" placeholder="{{ t.imei_placeholder }}" required>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label class="label">{{ t.battery_condition }}</label>
                                    <input id="battery-input" type="number" class="input" placeholder="{{ t.battery_placeholder }}" min="0" max="100" required>
                                </div>
                            </div>
                        </div>

            <!-- MacBook –±–ª–æ–∫ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω - —Å–µ–π—á–∞—Å —Ç–æ–ª—å–∫–æ iPhone
            <div id="macBlock" class="hidden-group">
                <div class="form-group">
                    <label class="label">–°–µ—Ä–∏—è MacBook</label>
                    <select id="macSeries" class="input">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–∏—é...</option>
                        <option value="air">MacBook Air</option>
                        <option value="pro">MacBook Pro</option>
                    </select>
                </div>

                <div id="macAirSpecs" class="hidden-group" style="margin-bottom: 16px;">
                    <label class="label">–ß–∏–ø (Air)</label>
                    <select class="input">
                        <option>M1</option>
                        <option>M2</option>
                        <option>M3</option>
                        <option>Intel (–°—Ç–∞—Ä—ã–µ)</option>
                    </select>
                </div>

                <div id="macProSpecs" class="hidden-group" style="margin-bottom: 16px;">
                    <label class="label">–ß–∏–ø (Pro)</label>
                    <select class="input">
                        <option>M1 Pro / Max</option>
                        <option>M2 Pro / Max</option>
                        <option>M3 Pro / Max</option>
                        <option>Intel i7 / i9</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="label">–û–ó–£ (RAM)</label>
                        <select class="input"><option>8 GB</option><option>16 GB</option><option>18 GB</option><option>24 GB</option><option>32 GB+</option></select>
                    </div>
                    <div class="form-group">
                        <label class="label">SSD</label>
                        <select class="input"><option>256 GB</option><option>512 GB</option><option>1 TB+</option></select>
                    </div>
                </div>
            </div>
            -->

            <div id="commonSpecs" class="hidden-group" style="border-top: 1px solid var(--color-border); padding-top: 20px; margin-top: 20px;">
                
                <div class="form-group">
                    <label class="label">{{ t.package_contents }}</label>
                    <div class="checkbox-group">
                        <label class="check-item"><input type="checkbox" name="has_original_box"> {{ t.original_box }}</label>
                        <label class="check-item"><input type="checkbox" name="has_charger"> {{ t.charger }}</label>
                        <label class="check-item"><input type="checkbox" name="has_cable"> {{ t.cable }}</label>
                        <label class="check-item"><input type="checkbox" name="has_receipt"> {{ t.receipt }}</label>
                        <label class="check-item"><input type="checkbox" name="has_warranty"> {{ t.warranty }}</label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="label">{{ t.device_condition }}</label>
                    <select id="condition-input" class="input">
                        <option value="">{{ t.select_condition_placeholder }}</option>
                        <option value="New">{{ t.new }}</option>
                        <option value="Like New">{{ t.like_new }}</option>
                        <option value="Minor Defects">{{ t.minor_defects }}</option>
                        <option value="With Defect">{{ t.with_defect }}</option>
                        <option value="For Parts">{{ t.for_parts }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="label">{{ t.price_label }}</label>
                    <input id="price-input" type="number" class="input" style="font-size: 20px; font-weight: bold;" min="0" required>
                </div>

                <div class="form-group">
                    <label class="label">{{ t.description_label }}</label>
                    <textarea class="input" id="description" rows="5" placeholder="{{ t.description_placeholder }}"></textarea>
                </div>

                <div class="form-group">
                    <label class="label">{{ t.photos_label }}</label>
                    <div class="photo-upload-zone" id="photoUploadZone">
                        <div style="font-size: 32px; margin-bottom: 8px;">üì∏</div>
                        <div style="font-weight: 600; margin-bottom: 4px;">{{ t.click_or_drag }}</div>
                        <div style="font-size: 13px; color: var(--color-text-light);">{{ t.supported_formats }}</div>
                        <input type="file" id="photoInput" multiple accept="image/*" style="display: none;">
                    </div>
                    <div class="photo-gallery" id="photoGallery"></div>
                    <div class="photo-count" id="photoCount">0 / 15 {{ t.photos_count }}</div>
                </div>

                <button type="button" id="publishBtn" class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px;">{{ t.publish_button }}</button>
            </div>

        </form>
    </div>

    <!-- Progress Modal -->
    <div class="progress-modal" id="progressModal">
        <div class="progress-box">
            <div class="progress-title">{{ t.uploading_ad }}</div>
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">{{ t.sending_data }}</div>
            <div class="progress-percent" id="progressPercent">0%</div>
        </div>
    </div>

    <script>
        // const catSelect = document.getElementById('catSelect'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ - –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω
        const iphoneBlock = document.getElementById('iphoneBlock');
        // const macBlock = document.getElementById('macBlock'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
        const commonSpecs = document.getElementById('commonSpecs');
        
        // const macSeries = document.getElementById('macSeries'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
        // const macAirSpecs = document.getElementById('macAirSpecs'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
        // const macProSpecs = document.getElementById('macProSpecs'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
        const photoUploadZone = document.getElementById('photoUploadZone');
        const photoInput = document.getElementById('photoInput');
        const photoGallery = document.getElementById('photoGallery');
        const photoCount = document.getElementById('photoCount');
        let photos = [];
        const MAX_PHOTOS = 15;
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 –ú–ë

        // –û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–æ–Ω—É
        photoUploadZone.addEventListener('click', () => photoInput.click());

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        photoInput.addEventListener('change', (e) => {
            addPhotos(e.target.files);
            photoInput.value = ''; // –°–±—Ä–æ—Å input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–±—Ä–∞—Ç—å —Ç–µ –∂–µ —Ñ–∞–π–ª—ã
        });

        // Drag & Drop
        photoUploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            photoUploadZone.classList.add('dragover');
        });

        photoUploadZone.addEventListener('dragleave', () => {
            photoUploadZone.classList.remove('dragover');
        });

        photoUploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            photoUploadZone.classList.remove('dragover');
            addPhotos(e.dataTransfer.files);
        });

        function addPhotos(files) {
            const availableSlots = MAX_PHOTOS - photos.length;
            let added = 0;

            for (let file of files) {
                if (added >= availableSlots) break;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
                if (file.size > MAX_FILE_SIZE) {
                    alert(`–§–∞–π–ª ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5 –ú–ë)`);
                    continue;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
                if (!file.type.startsWith('image/')) {
                    alert(`${file.name} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º`);
                    continue;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    photos.push({
                        file: file,
                        preview: e.target.result
                    });
                    renderPhotos();
                };
                reader.readAsDataURL(file);
                added++;
            }

            if (added < files.length && photos.length >= MAX_PHOTOS) {
                alert(`–ú–∞–∫—Å–∏–º—É–º –¥–æ—Å—Ç–∏–≥–Ω—É—Ç! –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ ${MAX_PHOTOS} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π`);
            }
        }

        function renderPhotos() {
            photoGallery.innerHTML = '';
            photos.forEach((photo, index) => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `
                    <img src="${photo.preview}" alt="Photo ${index + 1}">
                    <button class="delete-btn" data-index="${index}">‚úï</button>
                `;
                
                photoItem.querySelector('.delete-btn').addEventListener('click', () => {
                    photos.splice(index, 1);
                    renderPhotos();
                });
                
                photoGallery.appendChild(photoItem);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
            photoCount.textContent = `${photos.length} / ${MAX_PHOTOS} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π`;
            if (photos.length >= MAX_PHOTOS) {
                photoCount.classList.add('max');
                photoUploadZone.style.opacity = '0.5';
                photoUploadZone.style.pointerEvents = 'none';
            } else {
                photoCount.classList.remove('max');
                photoUploadZone.style.opacity = '1';
                photoUploadZone.style.pointerEvents = 'auto';
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ iPhone (–∫–∞—Ç–µ–≥–æ—Ä–∏—è –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞)
        iphoneBlock.style.display = 'block';
        commonSpecs.style.display = 'block';

        /* –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ - —Å–µ–π—á–∞—Å —Ç–æ–ª—å–∫–æ iPhone
        // –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
        catSelect.addEventListener('change', (e) => {
            const val = e.target.value;
            
            // –°–±—Ä–æ—Å
            iphoneBlock.style.display = 'none';
            macBlock.style.display = 'none';
            commonSpecs.style.display = 'none';

            if(val === 'iphone') {
                iphoneBlock.style.display = 'block';
                commonSpecs.style.display = 'block';
            } else if(val === 'macbook') {
                macBlock.style.display = 'block';
                commonSpecs.style.display = 'block';
            } else if (val) {
                commonSpecs.style.display = 'block';
            }
        });

        // –õ–æ–≥–∏–∫–∞ MacBook (Air vs Pro)
        macSeries.addEventListener('change', (e) => {
            const val = e.target.value;
            macAirSpecs.style.display = 'none';
            macProSpecs.style.display = 'none';

            if(val === 'air') {
                macAirSpecs.style.display = 'block';
            } else if(val === 'pro') {
                macProSpecs.style.display = 'block';
            }
        });
        */

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –Ω–∞ Posts API
        document.getElementById('publishBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            
            // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
            const publishBtn = document.getElementById('publishBtn');
            const progressModal = document.getElementById('progressModal');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º progress modal
            progressModal.classList.add('show');
            publishBtn.disabled = true;
            
            try {
                // ===== –®–ê–ì 1: –í–ê–õ–ò–î–ê–¶–ò–Ø –í–°–ï–• –ü–û–õ–ï–ô –ü–ï–†–ï–î –ó–ê–ì–†–£–ó–ö–û–ô –§–û–¢–û =====
                updateProgress(progressBar, progressText, progressPercent, 5, '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
                if (photos.length === 0) {
                    alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é');
                    progressModal.classList.remove('show');
                    publishBtn.disabled = false;
                    return;
                }
                
                // IMEI (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)
                const imeiInput = document.getElementById('imei-input');
                if (!imeiInput || !imeiInput.value || imeiInput.value.length !== 15 || !/^\d{15}$/.test(imeiInput.value)) {
                    alert('{{ t.imei_label }} - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ (15 —Ü–∏—Ñ—Ä)');
                    progressModal.classList.remove('show');
                    publishBtn.disabled = false;
                    return;
                }
                
                // –ë–∞—Ç–∞—Ä–µ—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)
                const batteryInput = document.getElementById('battery-input');
                if (!batteryInput || !batteryInput.value) {
                    alert('{{ t.battery_condition }} - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ');
                    progressModal.classList.remove('show');
                    publishBtn.disabled = false;
                    return;
                }
                
                // –¶–µ–Ω–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)
                const priceInput = document.getElementById('price-input');
                if (!priceInput || !priceInput.value) {
                    alert('{{ t.price_label }} - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ');
                    progressModal.classList.remove('show');
                    publishBtn.disabled = false;
                    return;
                }
                
                // –°–æ—Å—Ç–æ—è–Ω–∏–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)
                const conditionInput = document.getElementById('condition-input');
                if (!conditionInput || !conditionInput.value) {
                    alert('{{ t.device_condition }} - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ');
                    progressModal.classList.remove('show');
                    publishBtn.disabled = false;
                    return;
                }
                
                // ===== –®–ê–ì 2: –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ò REFRESH –¢–û–ö–ï–ù–ê =====
                updateProgress(progressBar, progressText, progressPercent, 10, '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
                
                const authCheck = await fetch(`${AUTH_API}/me`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (authCheck.status === 401) {
                    // –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
                    const refreshResponse = await fetch(`${AUTH_API}/refresh`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (!refreshResponse.ok) {
                        alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.');
                        progressModal.classList.remove('show');
                        publishBtn.disabled = false;
                        window.location.href = '/';
                        return;
                    }
                    
                    // –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                    const retryAuth = await fetch(`${AUTH_API}/me`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (!retryAuth.ok) {
                        alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                        progressModal.classList.remove('show');
                        publishBtn.disabled = false;
                        return;
                    }
                }
                
                // ===== –®–ê–ì 3: –ó–ê–ì–†–£–ó–ö–ê –§–û–¢–û–ì–†–ê–§–ò–ô =====
                updateProgress(progressBar, progressText, progressPercent, 20, '–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...');
                
                let imageUrls = [];
                if (photos.length > 0) {
                    console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º ${photos.length} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ Cloudflare...`);
                    imageUrls = await uploadPhotosToCloudflare(photos);
                    
                    if (imageUrls.length === 0) {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏');
                        progressModal.classList.remove('show');
                        publishBtn.disabled = false;
                        return;
                    }
                    console.log('–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', imageUrls);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å: 50% - —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                updateProgress(progressBar, progressText, progressPercent, 50, '–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');

                // ===== –®–ê–ì 4: –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–• –§–û–†–ú–´ =====
                const formData = new FormData();
                
                // –í—Å–µ –ø–æ–ª—è —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—ã—à–µ, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º
                formData.append('imei', imeiInput.value);
                formData.append('batery', batteryInput.value);
                formData.append('price', priceInput.value);
                formData.append('condition', conditionInput.value);
                
                // –û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ)
                const description = document.getElementById('description').value;
                if (description) {
                    formData.append('description', description);
                }
                
                // –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è (checkboxes)
                formData.append('has_original_box', document.querySelector('input[name="has_original_box"]').checked);
                formData.append('has_charger', document.querySelector('input[name="has_charger"]').checked);
                formData.append('has_cable', document.querySelector('input[name="has_cable"]').checked);
                formData.append('has_receipt', document.querySelector('input[name="has_receipt"]').checked);
                formData.append('has_warranty', document.querySelector('input[name="has_warranty"]').checked);
                
                // –î–æ–±–∞–≤–ª—è–µ–º URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤–º–µ—Å—Ç–æ —Å–∞–º–∏—Ö —Ñ–∞–π–ª–æ–≤
                if (imageUrls.length > 0) {
                    formData.append('images_url', imageUrls.join(','));
                }
                
                // ===== –®–ê–ì 5: –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –ù–ê –°–ï–†–í–ï–† =====
                updateProgress(progressBar, progressText, progressPercent, 80, '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ...');
                
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ Posts API...');
                const response = await fetch(`${POSTS_API}/iphone`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include' // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º cookies —Å JWT —Ç–æ–∫–µ–Ω–æ–º
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å: 100% - —É—Å–ø–µ—à–Ω–æ
                    updateProgress(progressBar, progressText, progressPercent, 100, '–ì–æ—Ç–æ–≤–æ!');
                    
                    setTimeout(() => {
                        alert(`–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω! ID: ${data.id}`);
                        // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–¥—É–∫—Ç–∞
                        window.location.href = `/product?id=${data.id}`;
                    }, 500);
                } else {
                    const error = await response.json();
                    console.log(error.detail)
                    progressModal.classList.remove('show');
                    alert(`–û—à–∏–±–∫–∞: ${error.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç'}`);
                }
            } catch (error) {
                console.log(error)
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:', error);
                progressModal.classList.remove('show');
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            } finally {
                publishBtn.disabled = false;
                progressModal.classList.remove('show');
            }
        });

        // Helper —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgress(progressBar, progressText, progressPercent, percent, text) {
            progressBar.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
            progressText.textContent = text;
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ Cloudflare R2
         * @param {Array} photosArray - –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å file –∏ preview
         * @returns {Promise<Array>} –ú–∞—Å—Å–∏–≤ URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
         */
        async function uploadPhotosToCloudflare(photosArray) {
            const uploadedUrls = [];

            try {
                for (let i = 0; i < photosArray.length; i++) {
                    const photo = photosArray[i];
                    
                    try {
                        // –î–ª—è –∫–∞–∂–¥–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–ª—É—á–∞–µ–º —Å–≤–æ–π URL –∑–∞–≥—Ä—É–∑–∫–∏
                        console.log(`–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ ${i + 1}/${photosArray.length}...`);
                        const urlResponse = await fetch(`${POSTS_API}/r2_link`);
                        
                        if (!urlResponse.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è URL: ${urlResponse.status}`);
                        }
                        
                        const linkData = await urlResponse.json();
                        const uploadUrl = linkData.upload_url;
                        const imageDeliveryBase = linkData.image_delivery_base;

                        console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ ${i + 1}/${photosArray.length}...`);
                        console.log(`–¢–∏–ø —Ñ–∞–π–ª–∞: ${photo.file.type}, –†–∞–∑–º–µ—Ä: ${(photo.file.size / 1024).toFixed(2)} KB`);

                        // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ (Cloudflare –æ–∂–∏–¥–∞–µ—Ç –∏–º–µ–Ω–Ω–æ —ç—Ç–æ)
                        const formData = new FormData();
                        formData.append('file', photo.file);  // –í–ê–ñ–ù–û: –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 'file'

                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ Cloudflare
                        const uploadResponse = await fetch(uploadUrl, {
                            method: 'POST',
                            body: formData
                            // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Content-Type - –±—Ä–∞—É–∑–µ—Ä —Å–∞–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π multipart/form-data
                        });

                        console.log(`–û—Ç–≤–µ—Ç Cloudflare: ${uploadResponse.status} ${uploadResponse.statusText}`);

                        if (!uploadResponse.ok) {
                            const errorText = await uploadResponse.text();
                            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ ${i + 1}: ${uploadResponse.status}`);
                            console.error(`–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏: ${errorText}`);
                            continue;
                        }

                        // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç Cloudflare —Å —Ä–µ–∞–ª—å–Ω—ã–º image_id
                        const cloudflareResponse = await uploadResponse.json();
                        console.log(`–û—Ç–≤–µ—Ç Cloudflare (–ø–æ–ª–Ω—ã–π):`, cloudflareResponse);
                        
                        const imageId = cloudflareResponse.result.id;
                        const publicUrl = `${imageDeliveryBase}/${imageId}/test`;
                        
                        console.log(`‚úì –ü—É–±–ª–∏—á–Ω—ã–π URL: ${publicUrl}`);
                        
                        uploadedUrls.push(publicUrl);
                        console.log(`–§–æ—Ç–æ ${i + 1} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${publicUrl}`);

                    } catch (error) {
                        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ ${i + 1}:`, error);
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ –¥–∞–∂–µ –µ—Å–ª–∏ –æ–¥–Ω–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
                    }
                }

                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${uploadedUrls.length} –∏–∑ ${photosArray.length} —Ñ–æ—Ç–æ`);
                return uploadedUrls;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ Cloudflare:', error);
                return [];
            }
        }
    </script>

</body>
</html>
