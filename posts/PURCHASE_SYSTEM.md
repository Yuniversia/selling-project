# Система покупок - Документация

## Обзор

Реализована полная система оформления покупок с автоматическим заполнением данных из профиля пользователя и деактивацией объявлений после покупки.

## Архитектура

### Backend (Posts Service)

**Новые файлы:**
- `bought_models.py` - Модели данных для покупок
- `bought_router.py` - API endpoints для покупок
- `migrate_add_bought_table.py` - Миграция БД

**Таблица `bought` в базе данных:**
```sql
CREATE TABLE bought (
    id INTEGER PRIMARY KEY,
    post_id INTEGER NOT NULL,           -- ID объявления
    buyer_id INTEGER NOT NULL,          -- ID покупателя
    buyer_name VARCHAR(150),
    buyer_surname VARCHAR(150),
    buyer_phone VARCHAR(20),
    buyer_email VARCHAR(150),
    delivery_address VARCHAR(500),
    status VARCHAR(50),                 -- Статус заказа
    created_at TIMESTAMP,
    updated_at TIMESTAMP
)
```

**Статусы заказа:**
1. "Ждет отправки" (по умолчанию)
2. "Отправляется"
3. "Ждёт получения"
4. "Получен"
5. "Одобрен"
6. "Возврат"

### API Endpoints

#### POST /api/v1/bought/
Создаёт заказ на покупку товара.

**Требования:**
- JWT токен в cookies (авторизация)
- Объявление должно быть активным
- Нельзя купить собственное объявление

**Request Body:**
```json
{
  "post_id": 123,
  "buyer_name": "Иван",              // Опционально (берётся из профиля)
  "buyer_surname": "Иванов",         // Опционально (берётся из профиля)
  "buyer_phone": "+371 12345678",    // Опционально (берётся из профиля)
  "buyer_email": "ivan@example.com", // Опционально (берётся из профиля)
  "delivery_address": "Улица Ленина, 10" // Обязательно
}
```

**Response (201 Created):**
```json
{
  "id": 1,
  "post_id": 123,
  "buyer_id": 5,
  "buyer_name": "Иван",
  "buyer_surname": "Иванов",
  "buyer_phone": "+371 12345678",
  "buyer_email": "ivan@example.com",
  "delivery_address": "Улица Ленина, 10",
  "status": "Ждет отправки",
  "created_at": "2025-11-29T12:00:00",
  "updated_at": "2025-11-29T12:00:00"
}
```

**Errors:**
- `401` - Не авторизован
- `404` - Объявление не найдено
- `400` - Объявление неактивно / Покупка собственного товара / Недостаточно данных

#### GET /api/v1/bought/my-purchases
Получает список покупок текущего пользователя.

**Response (200 OK):**
```json
[
  {
    "id": 1,
    "post_id": 123,
    "buyer_id": 5,
    "buyer_name": "Иван",
    "buyer_surname": "Иванов",
    "buyer_phone": "+371 12345678",
    "buyer_email": "ivan@example.com",
    "delivery_address": "Улица Ленина, 10",
    "status": "Ждет отправки",
    "created_at": "2025-11-29T12:00:00",
    "updated_at": "2025-11-29T12:00:00"
  }
]
```

### Frontend (product.html)

**Новые модальные окна:**

1. **Модальное окно покупки (`#purchaseModal`)**
   - Форма с полями: имя, фамилия, телефон, email, адрес доставки
   - Автозаполнение из профиля пользователя
   - Валидация обязательных полей
   - Отображение ошибок

2. **Модальное окно контакта (`#contactModal`)**
   - Показывает телефон и email продавца
   - Открывается по кнопке "Написать"

**JavaScript функции:**

```javascript
// Открытие модального окна покупки
openPurchaseModal()

// Закрытие модального окна
closePurchaseModal()

// Автозаполнение из профиля
loadUserProfileData()

// Отправка заказа
document.getElementById('purchaseForm').submit

// Контакт с продавцом
openContactModal()
closeContactModal()
```

## Логика работы

### Процесс покупки:

1. **Пользователь нажимает "Купить"**
   - Открывается модальное окно
   - Автоматически загружаются данные из профиля (если авторизован)

2. **Заполнение формы**
   - Если данные в профиле заполнены - поля автозаполняются
   - Пользователь может изменить любые поля
   - Адрес доставки - всегда обязателен

3. **Отправка заказа**
   - POST запрос на `/api/v1/bought/`
   - Backend проверяет авторизацию
   - Backend проверяет что объявление активно
   - Backend создаёт запись в таблице `bought`
   - **Объявление становится неактивным** (`active = False`)

4. **После покупки**
   - Модальное окно закрывается
   - Показывается сообщение "Покупка оформлена!"
   - Страница перезагружает данные поста
   - Кнопка "Купить" больше не активна (т.к. объявление неактивно)

### Автозаполнение данных:

```javascript
// Если в профиле есть данные:
if (userData.name) → автозаполнить имя
if (userData.surname) → автозаполнить фамилию
if (userData.phone) → автозаполнить телефон
if (userData.email) → автозаполнить email

// Если данных нет - пользователь заполняет вручную
```

### Валидация:

**Backend:**
- ✅ JWT токен обязателен
- ✅ Объявление должно существовать
- ✅ Объявление должно быть активно
- ✅ Нельзя купить свой товар
- ✅ Имя, фамилия, телефон, email - обязательны (из профиля или формы)
- ✅ Адрес доставки - обязателен всегда

**Frontend:**
- ✅ HTML5 валидация required полей
- ✅ Типы полей (email, tel)
- ✅ Отображение ошибок от сервера

## Примеры использования

### 1. Покупка с заполненным профилем

```javascript
// У пользователя в профиле есть все данные
// При открытии формы поля автоматически заполнятся
// Пользователь вводит только адрес доставки
// Нажимает "Купить"

POST /api/v1/bought/
{
  "post_id": 123,
  "delivery_address": "Улица Ленина, 10"
}

// Backend возьмёт данные из профиля автоматически
```

### 2. Покупка без профиля

```javascript
// Пользователь не заполнил профиль
// Заполняет все поля вручную в форме
// Нажимает "Купить"

POST /api/v1/bought/
{
  "post_id": 123,
  "buyer_name": "Иван",
  "buyer_surname": "Иванов",
  "buyer_phone": "+371 12345678",
  "buyer_email": "ivan@example.com",
  "delivery_address": "Улица Ленина, 10"
}
```

### 3. Контакт с продавцом

```javascript
// Пользователь нажимает "Написать"
// Открывается модальное окно с контактами продавца
// Показывается телефон и email
```

## Безопасность

- ✅ JWT аутентификация для всех операций
- ✅ Проверка прав (нельзя купить свой товар)
- ✅ Проверка статуса объявления
- ✅ CORS настроен для localhost
- ✅ Транзакции БД (rollback при ошибке)

## База данных

**Связи:**
```
bought.post_id → iphone.id
bought.buyer_id → user.id
```

**Индексы:**
```sql
idx_bought_post_id   -- для быстрого поиска по объявлению
idx_bought_buyer_id  -- для быстрого поиска по покупателю
```

## Запуск

1. Выполнить миграцию:
```bash
cd posts
python migrate_add_bought_table.py
```

2. Запустить posts service:
```bash
cd posts
uvicorn main:app --reload --port 3000
```

3. Открыть страницу товара:
```
http://localhost:8080/product?id=123
```

## Тестирование

### Сценарии тестирования:

1. ✅ Покупка с заполненным профилем
2. ✅ Покупка без профиля (ввод данных вручную)
3. ✅ Попытка купить свой товар (должна быть заблокирована)
4. ✅ Попытка купить неактивное объявление (должна быть заблокирована)
5. ✅ Покупка без авторизации (должна требовать логин)
6. ✅ Деактивация объявления после покупки
7. ✅ Просмотр контактов продавца

## Расширения (будущее)

- [ ] Добавить email уведомления продавцу и покупателю
- [ ] Добавить страницу "Мои покупки" для покупателя
- [ ] Добавить страницу "Мои продажи" для продавца
- [ ] Добавить возможность изменения статуса заказа продавцом
- [ ] Добавить систему отзывов после получения товара
- [ ] Добавить интеграцию с платёжными системами
- [ ] Добавить трекинг доставки
